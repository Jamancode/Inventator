<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventartor</title>
    <style>
        /* ===== CSS Variables & Root Styles ===== */
        :root {
            /* Grün-Pastell Farbschema mit optimalen Kontrasten */
            --primary-green: #52b788;
            --primary-dark: #2d6a4f;
            --primary-light: #95d5b2;
            --accent-green: #74c69d;
            --background-light: #f1faee;
            --background-white: #ffffff;
            --text-dark: #1b4332;
            --text-medium: #40916c;
            --text-light: #52b788;
            --shadow-color: rgba(45, 106, 79, 0.1);
            --border-color: #d8f3dc;
            --error-color: #e63946;
            --warning-color: #f77f00;
            --success-color: #06ffa5;
            --info-color: #4ecdc4;

            /* Animationen */
            --transition-fast: 0.2s ease;
            --transition-medium: 0.4s ease;
            --transition-slow: 0.6s ease;

            /* Layout */
            --header-height: 60px;
            --sidebar-width: 280px;
            --border-radius: 12px;
            --border-radius-small: 8px;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --primary-green: #74c69d;
            --primary-dark: #95d5b2;
            --primary-light: #40916c;
            --accent-green: #52b788;
            --background-light: #081c15;
            --background-white: #1b4332;
            --text-dark: #f1faee;
            --text-medium: #b7e4c7;
            --text-light: #95d5b2;
            --shadow-color: rgba(149, 213, 178, 0.1);
            --border-color: #2d6a4f;
        }

        /* ===== Reset & Base Styles ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color var(--transition-medium), color var(--transition-medium);
            font-size: 1.1rem; /* Größere Schrift für bessere Lesbarkeit */
        }

        /* ===== Loading Screen ===== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-green) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== Header ===== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--background-white);
            box-shadow: 0 2px 20px var(--shadow-color);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            transition: all var(--transition-medium);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-green), var(--accent-green));
            border-radius: var(--border-radius-small);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* ===== Burger Menu ===== */
        .burger-menu {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--spacing-sm);
            position: relative;
            width: 40px;
            height: 40px;
        }

        .burger-line {
            position: absolute;
            left: 8px;
            height: 3px;
            width: 24px;
            background: var(--text-dark);
            border-radius: 2px;
            transition: all var(--transition-fast);
        }

        .burger-line:nth-child(1) { top: 10px; }
        .burger-line:nth-child(2) { top: 19px; }
        .burger-line:nth-child(3) { bottom: 10px; }

        .burger-menu.active .burger-line:nth-child(1) {
            transform: rotate(45deg);
            top: 19px;
        }

        .burger-menu.active .burger-line:nth-child(2) {
            opacity: 0;
        }

        .burger-menu.active .burger-line:nth-child(3) {
            transform: rotate(-45deg);
            bottom: 18px;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-medium);
            transition: all var(--transition-fast);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-small);
        }

        .theme-toggle:hover {
            background: var(--background-light);
            color: var(--primary-dark);
            transform: rotate(180deg);
        }

        /* ===== Main Layout ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
            padding-top: var(--header-height);
        }

        /* ===== Sidebar Navigation ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--background-white);
            box-shadow: 2px 0 20px var(--shadow-color);
            padding: var(--spacing-lg);
            overflow-y: auto;
            transition: all var(--transition-medium);
            position: fixed;
            left: 0;
            top: var(--header-height);
            bottom: 0;
            z-index: 900;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 899;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-medium);
            font-weight: 500;
            font-size: 1.1rem;
        }

        .nav-item:hover {
            background: var(--background-light);
            color: var(--primary-dark);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-green), var(--accent-green));
            color: white;
            box-shadow: 0 5px 15px rgba(82, 183, 136, 0.3);
        }

        .nav-icon {
            font-size: 1.25rem;
            min-width: 24px;
        }

        /* ===== Main Content ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: var(--spacing-lg);
            transition: margin-left var(--transition-medium);
        }

        /* ===== Dashboard Stats ===== */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: var(--background-white);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: 0 5px 20px var(--shadow-color);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-green), var(--accent-green));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform var(--transition-medium);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow-color);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: var(--background-light);
            border-radius: var(--border-radius-small);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary-green);
            margin-bottom: var(--spacing-md);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            color: var(--text-medium);
            font-size: 1rem;
        }

        /* ===== Content Sections ===== */
        .content-section {
            background: var(--background-white);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            box-shadow: 0 5px 20px var(--shadow-color);
            margin-bottom: var(--spacing-xl);
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        /* ===== Forms ===== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            background: var(--background-white);
            color: var(--text-dark);
            font-size: 1.1rem;
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(82, 183, 136, 0.1);
        }

        /* ===== Buttons ===== */
        .btn {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius-small);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-green), var(--accent-green));
            color: white;
            box-shadow: 0 5px 15px rgba(82, 183, 136, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(82, 183, 136, 0.4);
        }

        .btn-secondary {
            background: var(--background-light);
            color: var(--text-dark);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            border-color: var(--primary-green);
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background: #d62828;
            transform: translateY(-2px);
        }

        /* ===== Modal ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
            padding: var(--spacing-md);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--background-white);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform var(--transition-medium);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-medium);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-small);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--background-light);
            color: var(--error-color);
            transform: rotate(90deg);
        }

        /* ===== Inventory Grid ===== */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .inventory-item {
            background: var(--background-white);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            transition: all var(--transition-fast);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .inventory-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(82, 183, 136, 0.1));
            transform: translateX(-100%);
            transition: transform var(--transition-medium);
        }

        .inventory-item:hover {
            border-color: var(--primary-green);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px var(--shadow-color);
        }

        .inventory-item:hover::before {
            transform: translateX(0);
        }

        .item-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--border-radius-small);
            margin-bottom: var(--spacing-md);
        }

        .item-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: var(--spacing-sm);
            font-size: 1.2rem;
        }

        .item-id {
            font-size: 0.9rem;
            color: var(--text-medium);
            font-family: monospace;
        }

        .item-location {
            font-size: 1rem;
            color: var(--text-medium);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .item-position {
            font-size: 0.9rem;
            color: var(--primary-green);
            font-style: italic;
        }

        /* ===== Progress Bars ===== */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--background-light);
            border-radius: 5px;
            overflow: hidden;
            margin-top: var(--spacing-xs);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green), var(--accent-green));
            transition: width var(--transition-medium);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ===== Voice Control ===== */
        .voice-section {
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            text-align: center;
        }

        .voice-input-area {
            margin: var(--spacing-xl) 0;
        }

        .voice-input {
            width: 100%;
            max-width: 600px;
            padding: var(--spacing-lg);
            font-size: 1.3rem;
            background: var(--background-white);
            border: 3px solid var(--primary-green);
            border-radius: var(--border-radius);
            color: var(--text-dark);
            text-align: center;
            margin: 0 auto var(--spacing-lg);
            display: block;
        }

        .voice-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary-green), var(--accent-green));
            color: white;
            font-size: 4rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            box-shadow: 0 10px 30px rgba(82, 183, 136, 0.3);
            margin: 0 auto;
        }

        .voice-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(82, 183, 136, 0.4);
        }

        .voice-button.listening {
            animation: pulse 1.5s ease infinite;
            background: linear-gradient(135deg, #e63946, #d62828);
        }

        .voice-result {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--background-white);
            border-radius: var(--border-radius);
            font-size: 1.2rem;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: pre-wrap;
            line-height: 1.8;
        }

        /* ===== Room Planner Canvas ===== */
        .planner-container {
            position: relative;
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
        }

        .planner-toolbar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }

        .planner-tool {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--background-white);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 1rem;
        }

        .planner-tool.active {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        .planner-canvas {
            width: 100%;
            height: 500px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-small);
            cursor: crosshair;
            position: relative;
            overflow: hidden;
        }

        .room-object {
            position: absolute;
            background: var(--primary-light);
            border: 2px solid var(--primary-green);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.9rem;
            cursor: move;
            user-select: none;
            min-width: 80px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .room-object.selected {
            border-color: var(--error-color);
            box-shadow: 0 0 0 2px rgba(230, 57, 70, 0.3);
        }

        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary-dark);
            border-radius: 50%;
        }

        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* ===== Maintenance Section ===== */
        .maintenance-grid {
            display: grid;
            gap: var(--spacing-md);
        }

        .maintenance-card {
            background: var(--background-light);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--warning-color);
        }

        .maintenance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .maintenance-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .maintenance-interval {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .interval-item {
            background: var(--background-white);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-small);
            font-size: 0.9rem;
        }

        /* ===== Analytics Section ===== */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .chart-container {
            background: var(--background-white);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: 0 5px 20px var(--shadow-color);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: var(--spacing-md);
        }

        .chart {
            width: 100%;
            height: 300px;
            position: relative;
        }

        /* ===== Filter Chips ===== */
        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .filter-chip {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--background-light);
            border: 2px solid transparent;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .filter-chip:hover {
            border-color: var(--primary-green);
            transform: translateY(-2px);
        }

        .filter-chip.active {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        /* ===== Notifications ===== */
        .notification-container {
            position: fixed;
            top: calc(var(--header-height) + var(--spacing-lg));
            right: var(--spacing-lg);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 400px;
        }

        .notification {
            background: var(--background-white);
            border-radius: var(--border-radius-small);
            padding: var(--spacing-md) var(--spacing-lg);
            box-shadow: 0 5px 20px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            animation: slideInRight 0.5s ease;
            position: relative;
            overflow: hidden;
            font-size: 1.1rem;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-green);
        }

        .notification.error::before {
            background: var(--error-color);
        }

        .notification.warning::before {
            background: var(--warning-color);
        }

        .notification.success::before {
            background: var(--success-color);
        }

        /* ===== Responsive Design - Mobile First ===== */
        @media (max-width: 768px) {
            :root {
                --header-height: 56px;
                --spacing-lg: 1rem;
                --spacing-xl: 1.5rem;
            }

            body {
                font-size: 1rem;
            }

            .burger-menu {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                width: 85%;
                max-width: 300px;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding: var(--spacing-md);
            }

            .header-actions .btn-text {
                display: none;
            }

            .logo-text {
                display: none;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: stretch;
            }

            .voice-button {
                width: 120px;
                height: 120px;
                font-size: 3rem;
            }

            .modal-content {
                margin: var(--spacing-md);
                padding: var(--spacing-lg);
            }

            .notification-container {
                left: var(--spacing-md);
                right: var(--spacing-md);
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stat-value {
                font-size: 2rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .planner-canvas {
                height: 400px;
            }
        }

        /* ===== Print Styles ===== */
        @media print {
            .header,
            .sidebar,
            .sidebar-overlay,
            .notification-container,
            .btn,
            .modal {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
            }

            .content-section {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
        }

        /* ===== Utility Classes ===== */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .text-center {
            text-align: center;
        }

        .mt-md {
            margin-top: var(--spacing-md);
        }

        .mb-md {
            margin-bottom: var(--spacing-md);
        }

        .flex {
            display: flex;
        }

        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gap-md {
            gap: var(--spacing-md);
        }

        /* ===== Skeleton Loading ===== */
        .skeleton {
            background: linear-gradient(90deg, var(--background-light) 25%, var(--border-color) 50%, var(--background-light) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Inventartor</h2>
            <p>Wird geladen...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="flex-center gap-md">
                <button class="burger-menu" id="burgerMenu" aria-label="Menü öffnen">
                    <span class="burger-line"></span>
                    <span class="burger-line"></span>
                    <span class="burger-line"></span>
                </button>
                <div class="logo">
                    <div class="logo-icon">📦</div>
                    <span class="logo-text">Inventartor</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="Theme umschalten">🌓</button>
                <button class="btn btn-primary" id="quickAddBtn">
                    <span>➕</span>
                    <span class="btn-text">Hinzufügen</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar" role="navigation">
            <div class="nav-item active" data-section="dashboard" tabindex="0">
                <span class="nav-icon">📊</span>
                <span class="nav-text">Dashboard</span>
            </div>
            <div class="nav-item" data-section="search" tabindex="0">
                <span class="nav-icon">🔍</span>
                <span class="nav-text">Suche & Filter</span>
            </div>
            <div class="nav-item" data-section="voice" tabindex="0">
                <span class="nav-icon">🎤</span>
                <span class="nav-text">Sprachsteuerung</span>
            </div>
            <div class="nav-item" data-section="inventory" tabindex="0">
                <span class="nav-icon">📦</span>
                <span class="nav-text">Inventar</span>
            </div>
            <div class="nav-item" data-section="add" tabindex="0">
                <span class="nav-icon">➕</span>
                <span class="nav-text">Hinzufügen</span>
            </div>
            <div class="nav-item" data-section="planner" tabindex="0">
                <span class="nav-icon">🏠</span>
                <span class="nav-text">Grundriss</span>
            </div>
            <div class="nav-item" data-section="analytics" tabindex="0">
                <span class="nav-icon">📈</span>
                <span class="nav-text">Analysen</span>
            </div>
            <div class="nav-item" data-section="maintenance" tabindex="0">
                <span class="nav-icon">🔧</span>
                <span class="nav-text">Wartung</span>
            </div>
            <div class="nav-item" data-section="settings" tabindex="0">
                <span class="nav-icon">⚙️</span>
                <span class="nav-text">Einstellungen</span>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Section -->
            <section class="content-section" id="dashboard-section">
                <div class="section-header">
                    <h1 class="section-title">Dashboard Übersicht</h1>
                    <button class="btn btn-secondary" id="refreshDashboard">
                        <span>🔄</span>
                        <span>Aktualisieren</span>
                    </button>
                </div>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon">📦</div>
                        <div class="stat-value" id="totalItems">0</div>
                        <div class="stat-label">Gegenstände gesamt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🏠</div>
                        <div class="stat-value" id="totalRooms">0</div>
                        <div class="stat-label">Räume</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📁</div>
                        <div class="stat-value" id="totalContainers">0</div>
                        <div class="stat-label">Container</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⚠️</div>
                        <div class="stat-value" id="lowStock">0</div>
                        <div class="stat-label">Wartung nötig</div>
                    </div>
                </div>

                <div class="content-section mt-md">
                    <h2 class="section-title">Zuletzt hinzugefügt</h2>
                    <div class="inventory-grid" id="recentItems">
                        <!-- Recent items will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Voice Control Section -->
            <section class="content-section hidden" id="voice-section">
                <div class="section-header">
                    <h1 class="section-title">🎤 Sprachsteuerung</h1>
                </div>

                <div class="voice-section">
                    <p style="font-size: 1.2rem; margin-bottom: var(--spacing-lg);">
                        Geben Sie einen Gegenstand ein oder nutzen Sie die Spracherkennung
                    </p>

                    <div class="voice-input-area">
                        <input type="text"
                               id="voiceTextInput"
                               class="voice-input"
                               placeholder="Gegenstand eingeben..."
                               autocomplete="off"
                               aria-label="Gegenstand suchen">

                        <button class="voice-button" id="voiceButton" aria-label="Spracherkennung starten">
                            🎤
                        </button>
                    </div>

                    <div class="voice-result" id="voiceResult">
                        Hier erscheint das Ergebnis Ihrer Suche
                    </div>
                </div>

                <div class="content-section mt-md">
                    <h3>Unterstützte Befehle</h3>
                    <ul style="font-size: 1.1rem; line-height: 1.8;">
                        <li>Sagen Sie einfach den Namen eines Gegenstands</li>
                        <li>Die App zeigt und spricht den genauen Standort</li>
                        <li>Beispiel: "Hammer" → "Dein Hammer liegt in: Werkstatt > Werkbank > Obere Schublade"</li>
                    </ul>
                </div>
            </section>

            <!-- Search Section -->
            <section class="content-section hidden" id="search-section">
                <div class="section-header">
                    <h1 class="section-title">Suche & Filter</h1>
                </div>

                <div class="search-container">
                    <input type="text"
                           class="form-input"
                           id="searchInput"
                           placeholder="Suche nach Namen, ID oder Eigenschaften..."
                           style="font-size: 1.2rem; padding: var(--spacing-lg);">
                </div>

                <div class="filter-chips">
                    <div class="filter-chip" data-filter="all">Alle</div>
                    <div class="filter-chip" data-filter="low-stock">🔴 Fast leer</div>
                    <div class="filter-chip" data-filter="full">🟢 Voll</div>
                    <div class="filter-chip" data-filter="poor-condition">⚠️ Schlechter Zustand</div>
                    <div class="filter-chip" data-filter="low-battery">🔋 Batterie schwach</div>
                    <div class="filter-chip" data-filter="maintenance">🔧 Wartung fällig</div>
                </div>

                <div class="mt-md">
                    <h3>Kategorien</h3>
                    <div class="filter-chips" id="categoryFilters">
                        <!-- Category filters will be populated here -->
                    </div>
                </div>

                <div class="inventory-grid mt-md" id="searchResults">
                    <!-- Search results will be populated here -->
                </div>
            </section>

            <!-- Add Item Section -->
            <section class="content-section hidden" id="add-section">
                <div class="section-header">
                    <h1 class="section-title">Neuen Gegenstand hinzufügen</h1>
                </div>

                <form id="addItemForm">
                    <div class="form-group">
                        <label class="form-label">Foto hinzufügen</label>
                        <input type="file" id="itemPhoto" accept="image/*" class="form-input">
                        <div id="photoPreview" class="mt-md"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Gegenstand *</label>
                        <input type="text" id="itemName" class="form-input" required placeholder="z.B. Akkuschrauber">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Raum *</label>
                            <select id="itemRoom" class="form-select" required>
                                <option value="">Raum auswählen...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Möbel (optional)</label>
                            <input type="text" id="itemFurniture" class="form-input" placeholder="z.B. Werkbank">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Container (optional)</label>
                            <input type="text" id="itemContainer" class="form-input" placeholder="z.B. Obere Schublade">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Position</label>
                            <select id="itemPosition" class="form-select">
                                <option value="darin">Darin</option>
                                <option value="oben drauf">Oben drauf</option>
                                <option value="unten drunter">Unten drunter</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Wartungsintervall (Tage)</label>
                            <input type="number" id="maintenanceInterval" class="form-input" min="1" placeholder="z.B. 30">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Laufzeit (Stunden)</label>
                            <input type="number" id="runtime" class="form-input" min="0" step="0.1" placeholder="z.B. 150.5">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Kategorie</label>
                        <div class="filter-chips" id="categorySelection">
                            <!-- Categories will be populated here -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Eigenschaften</label>
                        <div id="propertySliders">
                            <!-- Property sliders will be populated here -->
                        </div>
                        <button type="button" class="btn btn-secondary mt-md" id="addPropertyBtn">
                            ➕ Eigene Eigenschaft hinzufügen
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notizen</label>
                        <textarea id="itemNotes" class="form-textarea" rows="3" placeholder="Zusätzliche Informationen..."></textarea>
                    </div>

                    <div class="flex gap-md">
                        <button type="submit" class="btn btn-primary">
                            <span>💾</span>
                            <span>Speichern</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetFormBtn">
                            <span>🔄</span>
                            <span>Zurücksetzen</span>
                        </button>
                    </div>
                </form>
            </section>

            <!-- Inventory Section -->
            <section class="content-section hidden" id="inventory-section">
                <div class="section-header">
                    <h1 class="section-title">Inventar Übersicht</h1>
                    <div class="flex gap-md">
                        <button class="btn btn-secondary" id="toggleTreeView">
                            <span>🌳</span>
                            <span>Alle auf-/zuklappen</span>
                        </button>
                        <button class="btn btn-primary" id="exportInventory">
                            <span>📤</span>
                            <span>Exportieren</span>
                        </button>
                    </div>
                </div>

                <div id="inventoryTree">
                    <!-- Inventory tree will be populated here -->
                </div>
            </section>

            <!-- Room Planner Section -->
            <section class="content-section hidden" id="planner-section">
                <div class="section-header">
                    <h1 class="section-title">Grundriss Editor</h1>
                    <select id="roomSelect" class="form-select" style="width: 200px;">
                        <option value="">Raum auswählen...</option>
                    </select>
                </div>

                <div class="planner-container">
                    <div class="planner-toolbar">
                        <button class="planner-tool active" data-tool="select">👆 Auswählen</button>
                        <button class="planner-tool" data-tool="rectangle">⬜ Rechteck</button>
                        <button class="planner-tool" data-tool="delete">🗑️ Löschen</button>
                        <button class="planner-tool" data-tool="clear">🔄 Alles löschen</button>
                    </div>
                    <div class="planner-canvas" id="plannerCanvas">
                        <!-- Room objects will be added here -->
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section class="content-section hidden" id="analytics-section">
                <div class="section-header">
                    <h1 class="section-title">Analysen & Berichte</h1>
                    <div class="flex gap-md">
                        <button class="btn btn-primary" id="generateReport">
                            <span>📊</span>
                            <span>Bericht erstellen</span>
                        </button>
                        <button class="btn btn-secondary" id="exportAnalyticsJSON">
                            <span>📄</span>
                            <span>JSON Export</span>
                        </button>
                        <button class="btn btn-secondary" id="exportAnalyticsCSV">
                            <span>📊</span>
                            <span>Excel Export</span>
                        </button>
                    </div>
                </div>

                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Kategorieverteilung</h3>
                        <div class="chart" id="categoryChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Zustandsübersicht</h3>
                        <div class="chart" id="conditionChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Füllstandsanalyse</h3>
                        <div class="chart" id="fillLevelChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Raumauslastung</h3>
                        <div class="chart" id="roomUsageChart"></div>
                    </div>
                </div>

                <div class="content-section mt-md">
                    <h3>Detaillierte Statistiken</h3>
                    <div id="detailedStats">
                        <!-- Detailed statistics will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Maintenance Section -->
            <section class="content-section hidden" id="maintenance-section">
                <div class="section-header">
                    <h1 class="section-title">Wartung & Erinnerungen</h1>
                    <button class="btn btn-primary" id="maintenanceSettings">
                        <span>⚙️</span>
                        <span>Einstellungen</span>
                    </button>
                </div>

                <div class="filter-chips mb-md">
                    <div class="filter-chip active" data-maintenance="all">Alle</div>
                    <div class="filter-chip" data-maintenance="interval">Zeitintervall</div>
                    <div class="filter-chip" data-maintenance="runtime">Laufzeit</div>
                    <div class="filter-chip" data-maintenance="fillLevel">Füllstand</div>
                    <div class="filter-chip" data-maintenance="battery">Batteriestand</div>
                    <div class="filter-chip" data-maintenance="condition">Zustand</div>
                </div>

                <div class="maintenance-grid" id="maintenanceItems">
                    <!-- Maintenance items will be populated here -->
                </div>
            </section>

            <!-- Settings Section -->
            <section class="content-section hidden" id="settings-section">
                <div class="section-header">
                    <h1 class="section-title">Einstellungen</h1>
                </div>

                <div class="settings-panel">
                    <div class="content-section">
                        <h3 class="section-title">Wartungsgrenzwerte</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Füllstand Warnung unter (%)</label>
                                <input type="number" id="fillLevelThreshold" class="form-input" min="0" max="100" value="20">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Batteriestand Warnung unter (%)</label>
                                <input type="number" id="batteryThreshold" class="form-input" min="0" max="100" value="25">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Zustand Warnung unter (%)</label>
                                <input type="number" id="conditionThreshold" class="form-input" min="0" max="100" value="30">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Wartung X Tage vorher warnen</label>
                                <input type="number" id="maintenanceDaysBefore" class="form-input" min="1" value="7">
                            </div>
                        </div>
                    </div>

                    <div class="content-section">
                        <h3 class="section-title">Sprach-APIs</h3>

                        <div class="form-group">
                            <label class="form-label">Text-to-Speech Provider</label>
                            <select class="form-select" id="ttsProvider">
                                <option value="browser">Browser (Standard)</option>
                                <option value="google">Google Cloud TTS</option>
                                <option value="amazon">Amazon Polly</option>
                                <option value="azure">Azure Speech</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Speech-to-Text Provider</label>
                            <select class="form-select" id="sttProvider">
                                <option value="browser">Browser (Standard)</option>
                                <option value="google">Google Cloud STT</option>
                                <option value="azure">Azure Speech</option>
                                <option value="whisper">OpenAI Whisper</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Sprechgeschwindigkeit</label>
                            <input type="range" class="form-input" id="speechRate" min="0.5" max="2" step="0.1" value="1">
                            <div class="text-center mt-md">
                                <span id="speechRateValue">1.0</span>x
                            </div>
                        </div>
                    </div>

                    <div class="content-section">
                        <h3 class="section-title">Datenmanagement</h3>

                        <div class="form-group">
                            <label class="form-label">IDs anzeigen</label>
                            <label class="switch">
                                <input type="checkbox" id="showIDsToggle">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Daten exportieren</label>
                            <div class="flex gap-md">
                                <button class="btn btn-secondary" id="exportJSON">JSON</button>
                                <button class="btn btn-secondary" id="exportCSV">CSV (Excel)</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Daten importieren</label>
                            <input type="file" class="form-input" id="importFile" accept=".json,.csv">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Alle Daten löschen</label>
                            <button class="btn btn-danger" id="clearAllData">🗑️ Alles löschen</button>
                        </div>
                    </div>

                    <div class="content-section">
                        <h3 class="section-title">Kategorien & Eigenschaften</h3>

                        <div class="form-group">
                            <label class="form-label">Kategorien (eine pro Zeile)</label>
                            <textarea id="categoriesConfig" class="form-textarea" rows="8">📱 Elektronik
🔧 Werkzeug
👕 Kleidung
📚 Bücher
🍴 Küche
🎮 Gaming
🏠 Haushalt
💊 Medizin</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Standard-Eigenschaften (eine pro Zeile)</label>
                            <textarea id="propertiesConfig" class="form-textarea" rows="5">Füllstand
Zustand
Batterie
Sauberkeit
Wichtigkeit</textarea>
                        </div>

                        <button class="btn btn-primary" id="saveConfig">
                            <span>💾</span>
                            <span>Konfiguration speichern</span>
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Gegenstand Details</h3>
                <button class="modal-close" onclick="closeModal('itemModal')">✕</button>
            </div>
            <div id="modalContent">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <div class="modal" id="maintenanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Wartungseinstellungen</h3>
                <button class="modal-close" onclick="closeModal('maintenanceModal')">✕</button>
            </div>
            <div id="maintenanceModalContent">
                <!-- Maintenance settings will be populated here -->
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- JavaScript -->
    <script>
        // ===== Smart Inventar Organizer Pro 2.0 - Enhanced JavaScript =====

        // App State Management
        const AppState = {
            inventory: [],
            rooms: [],
            categories: [],
            properties: [],
            roomPlans: {},
            nextId: 1001, // Start ID counter
            settings: {
                theme: 'light',
                autoSave: true,
                showIDs: false,
                speechRate: 1,
                speechVolume: 1,
                ttsProvider: 'browser',
                sttProvider: 'browser',
                // Wartungsgrenzwerte
                fillLevelThreshold: 20,
                batteryThreshold: 25,
                conditionThreshold: 30,
                maintenanceDaysBefore: 7
            },
            currentSection: 'dashboard',
            filters: {
                search: '',
                category: null,
                conditions: []
            }
        };

        // ===== Initialization =====
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            hideLoadingScreen();
        });

        async function initializeApp() {
            loadDataFromStorage();
            setupEventListeners();
            updateDashboard();
            renderCurrentSection();

            // Load default categories and properties if not set
            if (AppState.categories.length === 0) {
                AppState.categories = [
                    '📱 Elektronik',
                    '🔧 Werkzeug',
                    '👕 Kleidung',
                    '📚 Bücher',
                    '🍴 Küche',
                    '🎮 Gaming',
                    '🏠 Haushalt',
                    '💊 Medizin'
                ];
            }

            if (AppState.properties.length === 0) {
                AppState.properties = [
                    'Füllstand',
                    'Zustand',
                    'Batterie',
                    'Sauberkeit',
                    'Wichtigkeit'
                ];
            }

            // Apply theme
            document.documentElement.setAttribute('data-theme', AppState.settings.theme);

            // Initialize speech rate display
            document.getElementById('speechRateValue').textContent = AppState.settings.speechRate.toFixed(1);
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }

        // ===== Data Management =====
        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('inventarProData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    // Carefully assign parsed data to AppState to avoid breaking AppState structure
                    // if saved data is malformed or from an older version.
                    for (const key in AppState) {
                        if (Object.prototype.hasOwnProperty.call(AppState, key) && Object.prototype.hasOwnProperty.call(parsed, key)) {
                            if (key === 'inventory' || key === 'categories' || key === 'properties' || key === 'roomPlans' || key === 'settings' || key === 'filters') {
                                // For objects and arrays, ensure they are of the correct type before assigning
                                if (typeof AppState[key] === typeof parsed[key]) {
                                     if (Array.isArray(AppState[key]) && !Array.isArray(parsed[key])) {
                                        // Keep default if types mismatch for arrays
                                    } else if (typeof AppState[key] === 'object' && AppState[key] !== null && !Array.isArray(AppState[key]) && (typeof parsed[key] !== 'object' || parsed[key] === null || Array.isArray(parsed[key]))) {
                                        // Keep default if types mismatch for objects
                                    }
                                    else {
                                        AppState[key] = parsed[key];
                                    }
                                }
                            } else {
                                AppState[key] = parsed[key];
                            }
                        }
                    }

                    let maxIdInInventory = 0;
                    if (AppState.inventory && Array.isArray(AppState.inventory) && AppState.inventory.length > 0) {
                        maxIdInInventory = AppState.inventory.reduce((max, item) => {
                            const itemIdNumber = parseInt(item.id);
                            const currentId = !isNaN(itemIdNumber) ? itemIdNumber : 0;
                            return currentId > max ? currentId : max;
                        }, 0);
                    }

                    const currentStoredNextId = parseInt(AppState.nextId);
                    const validCurrentNextId = !isNaN(currentStoredNextId) && currentStoredNextId > 0 ? currentStoredNextId : 1001;
                    AppState.nextId = Math.max(validCurrentNextId, maxIdInInventory + 1);

                } else {
                    // If no saved data, ensure critical structures are initialized and nextId is set to its default start value
                    AppState.inventory = AppState.inventory || [];
                    AppState.categories = AppState.categories || []; // Default provided in initializeApp if still empty
                    AppState.properties = AppState.properties || []; // Default provided in initializeApp if still empty
                    AppState.roomPlans = AppState.roomPlans || {};
                    AppState.settings = AppState.settings || { // Ensure settings object exists
                        theme: 'light', autoSave: true, showIDs: false, speechRate: 1, speechVolume: 1,
                        ttsProvider: 'browser', sttProvider: 'browser', fillLevelThreshold: 20,
                        batteryThreshold: 25, conditionThreshold: 30, maintenanceDaysBefore: 7
                    };
                    AppState.filters = AppState.filters || { search: '', category: null, conditions: [] };
                    AppState.nextId = 1001;
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Fehler beim Laden der Daten. Standardwerte werden verwendet.', 'error');
                // Initialize with default AppState structure if loading fails catastrophically
                const defaultNextId = 1001;
                AppState.inventory = [];
                AppState.rooms = [];
                AppState.categories = ['📱 Elektronik', '🔧 Werkzeug', '👕 Kleidung', '📚 Bücher', '🍴 Küche', '🎮 Gaming', '🏠 Haushalt', '💊 Medizin'];
                AppState.properties = ['Füllstand', 'Zustand', 'Batterie', 'Sauberkeit', 'Wichtigkeit'];
                AppState.roomPlans = {};
                AppState.nextId = defaultNextId;
                AppState.settings = {
                    theme: 'light', autoSave: true, showIDs: false, speechRate: 1, speechVolume: 1,
                    ttsProvider: 'browser', sttProvider: 'browser', fillLevelThreshold: 20,
                    batteryThreshold: 25, conditionThreshold: 30, maintenanceDaysBefore: 7
                };
                AppState.currentSection = 'dashboard';
                AppState.filters = { search: '', category: null, conditions: [] };
            }
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem('inventarProData', JSON.stringify(AppState));
                if (AppState.settings.autoSave) {
                    // Avoid too many notifications for autosave, perhaps only notify on manual save or first autosave.
                    // For now, keeping it as is.
                    // showNotification('Daten automatisch gespeichert', 'success'); // Consider making this less frequent
                }
            } catch (error) {
                console.error('Error saving data:', error);
                if (error.name === 'QuotaExceededError') {
                    showNotification('Fehler: Speicherlimit überschritten! Daten konnten nicht gespeichert werden.', 'error');
                } else {
                    showNotification('Fehler beim Speichern der Daten', 'error');
                }
            }
        }

        // ===== Event Listeners Setup =====
        function setupEventListeners() {
            // Burger Menu
            document.getElementById('burgerMenu').addEventListener('click', toggleMobileMenu);
            document.getElementById('sidebarOverlay').addEventListener('click', closeMobileMenu);

            // Theme Toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => navigateToSection(item.dataset.section));
                // Keyboard navigation
                item.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        navigateToSection(item.dataset.section);
                    }
                });
            });

            // Quick Add Button
            document.getElementById('quickAddBtn').addEventListener('click', () => {
                navigateToSection('add');
            });

            // Add Item Form
            document.getElementById('addItemForm').addEventListener('submit', handleAddItem);
            document.getElementById('itemPhoto').addEventListener('change', handlePhotoUpload);
            document.getElementById('resetFormBtn').addEventListener('click', resetAddForm);
            document.getElementById('addPropertyBtn').addEventListener('click', addCustomProperty);

            // Voice Control
            document.getElementById('voiceTextInput').addEventListener('input', (e) => {
                handleVoiceInput(e.target.value);
            });
            document.getElementById('voiceButton').addEventListener('click', startVoiceRecognition);

            // Search & Filters
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));

            // Settings
            document.getElementById('showIDsToggle').addEventListener('change', toggleShowIDs);
            document.getElementById('speechRate').addEventListener('input', updateSpeechRate);
            document.getElementById('ttsProvider').addEventListener('change', updateTTSProvider);
            document.getElementById('sttProvider').addEventListener('change', updateSTTProvider);
            document.getElementById('saveConfig').addEventListener('click', saveConfiguration);
            document.getElementById('exportJSON').addEventListener('click', exportJSON);
            document.getElementById('exportCSV').addEventListener('click', exportCSV);
            document.getElementById('importFile').addEventListener('change', handleImport);
            document.getElementById('clearAllData').addEventListener('click', clearAllData);

            // Room Planner
            initializeRoomPlanner();

            // Other buttons
            document.getElementById('refreshDashboard').addEventListener('click', updateDashboard);
            document.getElementById('toggleTreeView').addEventListener('click', toggleTreeView);
            document.getElementById('exportInventory').addEventListener('click', exportInventory);
            document.getElementById('generateReport').addEventListener('click', generateAnalyticsReport);
            document.getElementById('exportAnalyticsJSON').addEventListener('click', exportAnalyticsJSON);
            document.getElementById('exportAnalyticsCSV').addEventListener('click', exportAnalyticsCSV);
            document.getElementById('maintenanceSettings').addEventListener('click', openMaintenanceSettings);

            // Maintenance threshold inputs
            document.getElementById('fillLevelThreshold').addEventListener('change', updateMaintenanceThresholds);
            document.getElementById('batteryThreshold').addEventListener('change', updateMaintenanceThresholds);
            document.getElementById('conditionThreshold').addEventListener('change', updateMaintenanceThresholds);
            document.getElementById('maintenanceDaysBefore').addEventListener('change', updateMaintenanceThresholds);

            // Filter chips
            setupFilterChips();

            // Auto-save on window close
            window.addEventListener('beforeunload', () => {
                if (AppState.settings.autoSave) {
                    saveDataToStorage();
                    // No notification here to avoid pop-up during closing
                }
            });
        }

        // ===== Mobile Menu =====
        function toggleMobileMenu() {
            const burger = document.getElementById('burgerMenu');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            burger.classList.toggle('active');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const burger = document.getElementById('burgerMenu');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            burger.classList.remove('active');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        // ===== Theme Management =====
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            AppState.settings.theme = newTheme;
            saveDataToStorage();
            showNotification(`Theme auf ${newTheme === 'dark' ? 'Dunkel' : 'Hell'} geändert.`, 'info');
        }

        // ===== Navigation =====
        function navigateToSection(section) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.section === section);
            });

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.add('hidden');
            });

            // Show selected section
            const sectionElement = document.getElementById(`${section}-section`);
            if (sectionElement) {
                sectionElement.classList.remove('hidden');
            }

            AppState.currentSection = section;

            // Section-specific initialization
            switch (section) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'search':
                    initializeSearch();
                    break;
                case 'inventory':
                    renderInventoryTree();
                    break;
                case 'add':
                    initializeAddForm();
                    break;
                case 'planner':
                    initializePlanner();
                    break;
                case 'voice':
                    initializeVoiceControl();
                    break;
                case 'analytics':
                    renderAnalytics();
                    break;
                case 'maintenance':
                    renderMaintenance();
                    break;
                case 'settings':
                    renderSettings();
                    break;
            }

            // Close mobile menu if open
            closeMobileMenu();
        }

        function renderCurrentSection() {
            navigateToSection(AppState.currentSection);
        }

        // ===== Dashboard Functions =====
        function updateDashboard() {
            // Update statistics
            document.getElementById('totalItems').textContent = AppState.inventory.length;
            document.getElementById('totalRooms').textContent = new Set(AppState.inventory.map(item => item.room)).size;
            document.getElementById('totalContainers').textContent = new Set(AppState.inventory.map(item => `${item.room}-${item.furniture}-${item.container}`).filter(c => c !== '--')).size;

            // Calculate items needing maintenance
            const needsMaintenance = AppState.inventory.filter(item => {
                return checkMaintenanceNeeded(item);
            }).length;
            document.getElementById('lowStock').textContent = needsMaintenance;

            // Show recent items
            renderRecentItems();
        }

        function renderRecentItems() {
            const container = document.getElementById('recentItems');
            container.innerHTML = ''; // Clear previous items

            if (!AppState.inventory || AppState.inventory.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-medium);">Noch keine Gegenstände hinzugefügt.</p>';
                return;
            }

            const recentItems = AppState.inventory.slice(-4).reverse();

            recentItems.forEach(item => {
                const itemCard = createInventoryCard(item);
                container.appendChild(itemCard);
            });
        }

        // ===== ID Generation (Short IDs from bottom up) =====
        function generateItemId() {
            const id = AppState.nextId++;
            // saveDataToStorage(); // Deliberately not saving here, handleAddItem or other callers will save.
            return id.toString();
        }

        // ===== Voice Control (Simplified like the example) =====
        function initializeVoiceControl() {
            // Focus on input field for better accessibility
            document.getElementById('voiceTextInput').focus();
        }

        function handleVoiceInput(input) {
            const itemText = input.trim().toLowerCase();
            if (!itemText) {
                document.getElementById('voiceResult').textContent = 'Hier erscheint das Ergebnis Ihrer Suche';
                return;
            }

            const result = findItemByName(itemText);

            if (result) {
                const location = buildLocationString(result); // buildLocationString is now modified
                const output = `Dein ${result.name} liegt ${result.position || 'darin'} in: ${location}`; // "in:" remains here for context
                document.getElementById('voiceResult').textContent = output.replace('\n', ' '); // Display on one line
                speak(output);
            } else {
                const msg = `Ich habe "${input}" nicht gefunden.`;
                document.getElementById('voiceResult').textContent = msg;
                speak(msg);
            }
        }

        function findItemByName(searchTerm) {
            return AppState.inventory.find(item =>
                item.name.toLowerCase().includes(searchTerm)
            );
        }

        function buildLocationString(item) {
            let parts = [];
            if (item.room) {
                parts.push(item.room); // Just the room name first
            } else {
                parts.push('einem unbekannten Raum');
            }

            if (item.furniture) {
                parts.push(`im Möbelstück ${item.furniture}`);
            }

            if (item.container) {
                parts.push(`im Behälter ${item.container}`); // Changed "Container" to "Behälter" for better flow
            }

            // Join parts with a comma and space, then refine the grammar slightly for natural language.
            let locationString = parts.join(", ");

            // Refine sentence structure if multiple parts exist, e.g. "Room, in Furniture, in Container"
            // This simple join might be okay for speech, but for text display, it might need more.
            // For speech, "Raum, im Möbelstück X, im Behälter Y" should be acceptable.
            // The initial "in:" from the calling function provides the overall context.
            // Example: "liegt darin in: Küche, im Schrank, im oberen Fach"
            return locationString;
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'de-DE';
                utterance.rate = AppState.settings.speechRate || 1;
                utterance.volume = AppState.settings.speechVolume || 1;
                speechSynthesis.speak(utterance);
            } else {
                console.warn("Sprachsynthese wird von diesem Browser nicht unterstützt.");
                showNotification("Sprachsynthese nicht unterstützt.", "warning");
            }
        }

        function startVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                showNotification("Spracherkennung wird von diesem Browser nicht unterstützt.", "error");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'de-DE';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const button = document.getElementById('voiceButton');
            button.classList.add('listening');
            button.innerHTML = '👂';

            recognition.start();

            recognition.onresult = (event) => {
                const spoken = event.results[0][0].transcript;
                document.getElementById('voiceTextInput').value = spoken;
                handleVoiceInput(spoken);
            };

            recognition.onerror = (event) => {
                console.error("SpeechRecognition Fehler:", event.error);
                showNotification('Spracherkennung fehlgeschlagen: ' + event.error, 'error');
            };

            recognition.onend = () => {
                button.classList.remove('listening');
                button.innerHTML = '🎤';
            };
        }

        // ===== Inventory Management =====
        function handleAddItem(e) {
            e.preventDefault();

            const itemName = document.getElementById('itemName').value;
            const itemRoom = document.getElementById('itemRoom').value;

            if (!itemName || !itemRoom) {
                showNotification('Gegenstand und Raum sind Pflichtfelder!', 'error');
                return;
            }


            const formData = {
                id: generateItemId(),
                name: itemName,
                room: itemRoom,
                furniture: document.getElementById('itemFurniture').value || null,
                container: document.getElementById('itemContainer').value || null,
                position: document.getElementById('itemPosition').value,
                category: document.querySelector('#categorySelection .filter-chip.active')?.dataset.category || 'Sonstiges',
                photo: document.getElementById('photoPreview').querySelector('img')?.src || null,
                notes: document.getElementById('itemNotes').value,
                maintenanceInterval: parseInt(document.getElementById('maintenanceInterval').value) || null,
                runtime: parseFloat(document.getElementById('runtime').value) || 0,
                totalRuntime: 0,
                lastMaintenance: new Date().toISOString(),
                properties: {},
                dateAdded: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            document.querySelectorAll('#propertySliders .property-slider').forEach(slider => {
                const propertyName = slider.dataset.property;
                formData.properties[propertyName] = parseInt(slider.value);
            });

            AppState.inventory.push(formData);
            saveDataToStorage();
            showNotification(`${formData.name} wurde hinzugefügt!`, 'success');
            speak(`${formData.name} wurde erfolgreich hinzugefügt`);
            resetAddForm();
            initializeAddForm();

            if (AppState.currentSection === 'dashboard') {
                updateDashboard();
            }
        }

        function resetAddForm() {
            document.getElementById('addItemForm').reset();
            document.getElementById('photoPreview').innerHTML = '';
            document.querySelectorAll('#categorySelection .filter-chip.active').forEach(chip => {
                chip.classList.remove('active');
            });
             document.querySelectorAll('#propertySliders .property-slider').forEach(slider => {
                slider.value = 50;
                updateSliderValue(slider.dataset.property.replace(/\s+/g, '-').toLowerCase(), 50); // Use uniqueIdSuffix
            });
            document.getElementById('itemPosition').value = 'darin';
        }

        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const preview = document.getElementById('photoPreview');
                    preview.innerHTML = `<img src="${event.target.result}" alt="Vorschau" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function createInventoryCard(item) {
            const card = document.createElement('div');
            card.className = 'inventory-item';
            card.onclick = (event) => {
                event.stopPropagation();
                showItemDetails(item);
            };

            const photoHtml = item.photo
                ? `<img src="${item.photo}" alt="${item.name}" class="item-image">`
                : `<div class="item-image flex-center" style="background: var(--background-light); color: var(--text-medium); font-size: 3rem;">${item.category ? item.category.split(' ')[0] : '📦'}</div>`;

            const idHtml = AppState.settings.showIDs ? `<div class="item-id">ID: ${item.id}</div>` : '';
            const maintenanceIcon = checkMaintenanceNeeded(item) ? ' <span title="Wartung nötig" style="color: var(--warning-color);">🔧</span>' : '';
            const propertiesHtml = Object.entries(item.properties || {}).map(([key, value]) => {
                const percentage = parseInt(value) || 0;
                const color = percentage < (AppState.settings[`${key.toLowerCase()}Threshold`] || 30) ? 'var(--error-color)' : percentage < 70 ? 'var(--warning-color)' : 'var(--success-color)';
                return `
                    <div style="margin-top: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px;">
                            <span>${key}</span>
                            <span style="color: ${color}; font-weight: 600;">${percentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%; background: ${color};"></div>
                        </div>
                    </div>
                `;
            }).join('');

            card.innerHTML = `
                ${photoHtml}
                <div class="item-name">${item.name}${maintenanceIcon}</div>
                ${idHtml}
                <div class="item-location">
                    <span>📍</span>
                    <span>${buildLocationString(item)}</span>
                </div>
                ${item.position && item.position !== 'darin' ? `<div class="item-position">(${item.position})</div>` : ''}
                <div class="property-badge" style="background: var(--primary-light); color: var(--primary-dark); margin-top: 8px; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; display: inline-block;">
                    ${item.category}
                </div>
                ${propertiesHtml}
            `;
            return card;
        }

        function showItemDetails(item) {
            const modal = document.getElementById('itemModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            modalTitle.textContent = item.name;
            const photoHtml = item.photo ? `<img src="${item.photo}" alt="${item.name}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-bottom: 20px;">` : '';
            const propertiesHtml = Object.entries(item.properties || {}).map(([key, value]) => {
                 const uniqueIdSuffix = key.replace(/\s+/g, '-').toLowerCase();
                return `
                    <div class="form-group">
                        <label class="form-label">${key}: <span id="modal-value-${uniqueIdSuffix}">${value}</span>%</label>
                        <input type="range" class="form-input property-editor" data-property="${key}" value="${value}" min="0" max="100" oninput="updateModalSliderValue('${uniqueIdSuffix}', this.value)">
                        <div class="progress-bar mt-md">
                            <div class="progress-fill" id="modal-fill-${uniqueIdSuffix}" style="width: ${value}%;"></div>
                        </div>
                    </div>
                `;
            }).join('');

            modalContent.innerHTML = `
                ${photoHtml}
                <div class="form-group"><label class="form-label">ID</label><input type="text" class="form-input" value="${item.id}" readonly></div>
                <div class="form-group"><label class="form-label">Name</label><input type="text" id="modalItemName" class="form-input" value="${item.name}"></div>
                <div class="form-group"><label class="form-label">Standort (Raum)</label><input type="text" id="modalItemRoom" class="form-input" value="${item.room || ''}"></div>
                <div class="form-group"><label class="form-label">Möbel</label><input type="text" id="modalItemFurniture" class="form-input" value="${item.furniture || ''}"></div>
                <div class="form-group"><label class="form-label">Behälter</label><input type="text" id="modalItemContainer" class="form-input" value="${item.container || ''}"></div>
                <div class="form-group"><label class="form-label">Position</label><input type="text" id="modalItemPosition" class="form-input" value="${item.position || 'darin'}"></div>
                <div class="form-group"><label class="form-label">Kategorie</label><input type="text" id="modalItemCategory" class="form-input" value="${item.category || 'Sonstiges'}"></div>
                ${item.maintenanceInterval ? `<div class="form-group"><label class="form-label">Wartungsintervall</label><input type="number" id="modalMaintenanceInterval" class="form-input" value="${item.maintenanceInterval}"></div>` : '<div class="form-group"><label class="form-label">Wartungsintervall</label><input type="number" id="modalMaintenanceInterval" class="form-input" placeholder="z.B. 30"></div>'}
                ${item.runtime ? `<div class="form-group"><label class="form-label">Max. Laufzeit</label><input type="number" id="modalMaxRuntime" class="form-input" value="${item.runtime}"></div>` : '<div class="form-group"><label class="form-label">Max. Laufzeit</label><input type="number" id="modalMaxRuntime" class="form-input" placeholder="z.B. 2000"></div>'}
                <div class="form-group"><label class="form-label">Akt. Gesamtlaufzeit</label><input type="number" id="modalTotalRuntime" class="form-input" value="${item.totalRuntime || 0}"></div>
                ${propertiesHtml}
                <div class="form-group"><label class="form-label">Notizen</label><textarea id="modalItemNotes" class="form-textarea" rows="3">${item.notes || ''}</textarea></div>
                <div class="form-group"><label class="form-label">Hinzugefügt am</label><input type="text" class="form-input" value="${new Date(item.dateAdded).toLocaleString('de-DE')}" readonly></div>
                <div class="form-group"><label class="form-label">Zuletzt geändert</label><input type="text" class="form-input" value="${new Date(item.lastModified).toLocaleString('de-DE')}" readonly></div>
                <div class="flex gap-md">
                    <button class="btn btn-primary" onclick="updateItem('${item.id}')"><span>💾</span><span>Speichern</span></button>
                    <button class="btn btn-secondary" onclick="speakItemLocation('${item.id}')"><span>🔊</span><span>Standort vorlesen</span></button>
                    <button class="btn btn-danger" onclick="deleteItem('${item.id}')"><span>🗑️</span><span>Löschen</span></button>
                </div>
            `;
            modal.classList.add('active');
        }

        function updateModalSliderValue(idSuffix, value) {
            document.getElementById(`modal-value-${idSuffix}`).textContent = value;
            document.getElementById(`modal-fill-${idSuffix}`).style.width = value + '%';
        }

        function speakItemLocation(itemId) {
            const item = AppState.inventory.find(i => i.id === itemId);
            if (item) {
                const location = buildLocationString(item);
                const text = `${item.name} liegt ${item.position || 'darin'} in: ${location}`;
                speak(text);
            }
        }

        function updateItem(itemId) {
            const itemIndex = AppState.inventory.findIndex(i => i.id === itemId);
            if (itemIndex === -1) return;

            const item = AppState.inventory[itemIndex];
            item.name = document.getElementById('modalItemName').value;
            item.room = document.getElementById('modalItemRoom').value;
            item.furniture = document.getElementById('modalItemFurniture').value || null;
            item.container = document.getElementById('modalItemContainer').value || null;
            item.position = document.getElementById('modalItemPosition').value;
            item.category = document.getElementById('modalItemCategory').value || 'Sonstiges';
            item.notes = document.getElementById('modalItemNotes').value;
            item.maintenanceInterval = parseInt(document.getElementById('modalMaintenanceInterval')?.value) || null;
            item.runtime = parseFloat(document.getElementById('modalMaxRuntime')?.value) || null;
            item.totalRuntime = parseFloat(document.getElementById('modalTotalRuntime')?.value) || 0;

            item.properties = item.properties || {};
            document.querySelectorAll('#modalContent .property-editor').forEach(slider => {
                item.properties[slider.dataset.property] = parseInt(slider.value);
            });
            item.lastModified = new Date().toISOString();

            AppState.inventory[itemIndex] = item;
            saveDataToStorage();
            showNotification('Gegenstand aktualisiert!', 'success');
            closeModal('itemModal');
            renderCurrentSection();
        }

        function deleteItem(itemId) {
            if (confirm('Möchten Sie diesen Gegenstand wirklich löschen?')) {
                AppState.inventory = AppState.inventory.filter(i => i.id !== itemId);
                saveDataToStorage();
                showNotification('Gegenstand gelöscht!', 'success');
                closeModal('itemModal');
                renderCurrentSection();
                updateDashboard();
            }
        }

        // ===== Room Planner (Enhanced) =====
        let selectedObject = null;
        let currentTool = 'select';
        let isDragging = false;
        let isResizing = false;
        let dragOffset = { x: 0, y: 0 };
        let currentRoom = null;

        function initializeRoomPlanner() {
            document.querySelectorAll('.planner-tool').forEach(tool => {
                tool.addEventListener('click', () => selectPlannerTool(tool.dataset.tool));
            });
        }

        function initializePlanner() {
            const roomSelect = document.getElementById('roomSelect');
            roomSelect.innerHTML = '<option value="">Raum auswählen...</option>';
            const rooms = [...new Set(AppState.inventory.map(item => item.room).filter(Boolean))].sort();
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room; option.textContent = room;
                roomSelect.appendChild(option);
            });
            roomSelect.addEventListener('change', loadRoomPlan);
            if (currentRoom && rooms.includes(currentRoom)) {
                roomSelect.value = currentRoom;
            } else if (rooms.length > 0) {
                roomSelect.value = rooms[0];
            }
            loadRoomPlan(); // Load plan for selected or default room
        }

        function selectPlannerTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.planner-tool').forEach(t => t.classList.toggle('active', t.dataset.tool === tool));
            if (selectedObject) { selectedObject.classList.remove('selected'); selectedObject = null; }
        }

        function loadRoomPlan() {
            const roomSelect = document.getElementById('roomSelect');
            currentRoom = roomSelect.value;
            const canvas = document.getElementById('plannerCanvas');
            canvas.innerHTML = '';
            if (currentRoom && AppState.roomPlans && AppState.roomPlans[currentRoom]) {
                AppState.roomPlans[currentRoom].forEach(obj => createRoomObject(obj));
            }
            canvas.onclick = (e) => {
                if (currentTool === 'rectangle' && e.target === canvas) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                    const name = prompt('Name des Objekts (z.B. TV-Tisch):');
                    if (name) {
                        const obj = { id: Date.now().toString(), name: name, x: x - 50, y: y - 25, width: 100, height: 50 };
                        createRoomObject(obj); saveRoomPlan();
                    }
                } else if (currentTool === 'clear') {
                    if (confirm('Wirklich alle Objekte für diesen Raum löschen?')) {
                        canvas.innerHTML = '';
                        if (currentRoom && AppState.roomPlans) { AppState.roomPlans[currentRoom] = []; saveDataToStorage(); }
                    }
                }
            };
        }

        function createRoomObject(obj) {
            const canvas = document.getElementById('plannerCanvas');
            const element = document.createElement('div');
            element.className = 'room-object';
            element.style.left = obj.x + 'px'; element.style.top = obj.y + 'px';
            element.style.width = obj.width + 'px'; element.style.height = obj.height + 'px';
            element.textContent = obj.name; element.dataset.id = obj.id;
            ['nw', 'ne', 'sw', 'se'].forEach(handleType => {
                const resizeHandle = document.createElement('div');
                resizeHandle.className = `resize-handle ${handleType}`;
                element.appendChild(resizeHandle);
                resizeHandle.addEventListener('mousedown', (e) => startResize(e, handleType, element));
            });
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentTool === 'select') { selectObject(element); }
                else if (currentTool === 'delete') { if (confirm(`"${obj.name}" löschen?`)) { element.remove(); saveRoomPlan(); } }
            });
            canvas.appendChild(element);
        }

        function selectObject(element) {
            if (selectedObject) { selectedObject.classList.remove('selected'); }
            selectedObject = element; element.classList.add('selected');
        }

        function startDrag(e) {
            if (currentTool !== 'select' || e.target.classList.contains('resize-handle')) return;
            e.preventDefault();
            isDragging = true;
            const targetElement = e.target.closest('.room-object');
            if (!targetElement) return;
            selectObject(targetElement);
            const rect = targetElement.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left; dragOffset.y = e.clientY - rect.top;
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function drag(e) {
            if (!isDragging || !selectedObject) return; e.preventDefault();
            const canvas = document.getElementById('plannerCanvas'); const rect = canvas.getBoundingClientRect();
            let x = e.clientX - rect.left - dragOffset.x; let y = e.clientY - rect.top - dragOffset.y;
            x = Math.max(0, Math.min(x, rect.width - selectedObject.offsetWidth));
            y = Math.max(0, Math.min(y, rect.height - selectedObject.offsetHeight));
            selectedObject.style.left = x + 'px'; selectedObject.style.top = y + 'px';
        }

        function stopDrag() {
            if (isDragging) { isDragging = false; saveRoomPlan(); }
            document.removeEventListener('mousemove', drag); document.removeEventListener('mouseup', stopDrag);
        }

        function startResize(e, handleType, objectElement) {
            e.stopPropagation(); e.preventDefault(); isResizing = true; selectObject(objectElement);
            const initialRect = objectElement.getBoundingClientRect();
            const canvasRect = document.getElementById('plannerCanvas').getBoundingClientRect();
            const initialMouseX = e.clientX; const initialMouseY = e.clientY;
            const mouseMoveHandler = (moveEvent) => {
                if (!isResizing) return; moveEvent.preventDefault();
                const dx = moveEvent.clientX - initialMouseX; const dy = moveEvent.clientY - initialMouseY;
                let newX = parseInt(objectElement.style.left); let newY = parseInt(objectElement.style.top);
                let newWidth = initialRect.width; let newHeight = initialRect.height;
                if (handleType.includes('e')) newWidth += dx; if (handleType.includes('w')) { newWidth -= dx; newX += dx; }
                if (handleType.includes('s')) newHeight += dy; if (handleType.includes('n')) { newHeight -= dy; newY += dy; }
                newWidth = Math.max(40, newWidth); newHeight = Math.max(20, newHeight);
                newX = Math.max(0, Math.min(newX, canvasRect.width - newWidth));
                newY = Math.max(0, Math.min(newY, canvasRect.height - newHeight));
                if(newX + newWidth > canvasRect.width) newWidth = canvasRect.width - newX;
                if(newY + newHeight > canvasRect.height) newHeight = canvasRect.height - newY;
                objectElement.style.left = newX + 'px'; objectElement.style.top = newY + 'px';
                objectElement.style.width = newWidth + 'px'; objectElement.style.height = newHeight + 'px';
            };
            const mouseUpHandler = () => {
                if (isResizing) { isResizing = false; saveRoomPlan(); }
                document.removeEventListener('mousemove', mouseMoveHandler); document.removeEventListener('mouseup', mouseUpHandler);
            };
            document.addEventListener('mousemove', mouseMoveHandler); document.addEventListener('mouseup', mouseUpHandler);
        }

        function saveRoomPlan() {
            if (!currentRoom || !AppState.roomPlans) return;
            const canvas = document.getElementById('plannerCanvas'); const objects = [];
            canvas.querySelectorAll('.room-object').forEach(objEl => {
                objects.push({ id: objEl.dataset.id, name: objEl.textContent, x: parseInt(objEl.style.left), y: parseInt(objEl.style.top), width: parseInt(objEl.style.width), height: parseInt(objEl.style.height) });
            });
            AppState.roomPlans[currentRoom] = objects; saveDataToStorage();
            showNotification(`Grundriss für ${currentRoom} gespeichert.`, 'success');
        }

        // ===== Analytics Functions (Enhanced) =====
        function renderAnalytics() { renderCharts(); renderDetailedStats(); }
        function renderCharts() { renderCategoryChart(); renderConditionChart(); renderFillLevelChart(); renderRoomUsageChart(); }

        function renderCategoryChart() {
            const container = document.getElementById('categoryChart'); if (!container) return; container.innerHTML = '';
            const categoryCounts = {}; AppState.inventory.forEach(item => { categoryCounts[item.category] = (categoryCounts[item.category] || 0) + 1; });
            const total = AppState.inventory.length || 1; const maxCount = Math.max(...Object.values(categoryCounts), 1);
            Object.entries(categoryCounts).forEach(([category, count]) => {
                const percentage = (count / total * 100).toFixed(1); const barHeight = (count / maxCount * 250) || 0;
                const bar = document.createElement('div'); bar.style.cssText = `display: inline-block; width: 60px; margin: 0 10px; text-align: center; vertical-align: bottom;`;
                bar.innerHTML = `<div style="font-size: 0.9rem; margin-bottom: 5px;">${count}</div><div style="height: ${barHeight}px; background: linear-gradient(to top, var(--primary-green), var(--accent-green)); border-radius: 4px 4px 0 0; position: relative; margin-bottom: 5px; min-height: 20px; display: flex; align-items: flex-end; justify-content: center; color: white; font-weight: bold;">${percentage}%</div><div style="font-size: 0.8rem; word-break: break-all;">${category}</div>`;
                container.appendChild(bar);
            });
        }

        function renderConditionChart() {
            const container = document.getElementById('conditionChart'); if (!container) return; container.innerHTML = '';
            const conditions = { 'Sehr gut (80-100%)': 0, 'Gut (60-79%)': 0, 'Mittel (40-59%)': 0, 'Schlecht (20-39%)': 0, 'Sehr schlecht (0-19%)': 0 };
            AppState.inventory.forEach(item => {
                const condition = item.properties?.['Zustand'] || 100;
                if (condition >= 80) conditions['Sehr gut (80-100%)']++; else if (condition >= 60) conditions['Gut (60-79%)']++;
                else if (condition >= 40) conditions['Mittel (40-59%)']++; else if (condition >= 20) conditions['Schlecht (20-39%)']++; else conditions['Sehr schlecht (0-19%)']++;
            });
            const total = AppState.inventory.length || 1;
            Object.entries(conditions).forEach(([label, count]) => {
                const percentage = (count / total * 100).toFixed(1); const row = document.createElement('div'); row.style.marginBottom = '15px';
                row.innerHTML = `<div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>${label}</span><span>${count} (${percentage}%)</span></div><div class="progress-bar" style="height: 20px;"><div class="progress-fill" style="width: ${percentage}%;">${count > 0 ? count : ''}</div></div>`;
                container.appendChild(row);
            });
        }

        function renderFillLevelChart() {
            const container = document.getElementById('fillLevelChart'); if (!container) return; container.innerHTML = '';
            const fillLevels = { 'Voll (80-100%)': 0, 'Hoch (60-79%)': 0, 'Mittel (40-59%)': 0, 'Niedrig (20-39%)': 0, 'Leer (0-19%)': 0 };
            AppState.inventory.forEach(item => {
                const fill = item.properties?.['Füllstand'];
                if (fill !== undefined) {
                    if (fill >= 80) fillLevels['Voll (80-100%)']++; else if (fill >= 60) fillLevels['Hoch (60-79%)']++;
                    else if (fill >= 40) fillLevels['Mittel (40-59%)']++; else if (fill >= 20) fillLevels['Niedrig (20-39%)']++; else fillLevels['Leer (0-19%)']++;
                }
            });
            const totalWithFillLevel = Object.values(fillLevels).reduce((a,b) => a+b,0) || 1;
            let currentAngle = -Math.PI / 2; const centerX = 150; const centerY = 150; const radius = 120;
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 300 300'); svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%');
            const colors = ['#06ffa5', '#52b788', '#f77f00', '#e63946', '#d62828'].reverse();
            const levelOrder = ['Leer (0-19%)', 'Niedrig (20-39%)', 'Mittel (40-59%)', 'Hoch (60-79%)', 'Voll (80-100%)'];
            levelOrder.forEach((label, index) => {
                const count = fillLevels[label]; if (count === 0) return;
                const percentage = count / totalWithFillLevel; const angle = percentage * 2 * Math.PI;
                const x1 = centerX + radius * Math.cos(currentAngle); const y1 = centerY + radius * Math.sin(currentAngle);
                const x2 = centerX + radius * Math.cos(currentAngle + angle); const y2 = centerY + radius * Math.sin(currentAngle + angle);
                const largeArcFlag = angle > Math.PI ? 1 : 0;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`);
                path.setAttribute('fill', colors[index % colors.length]); path.setAttribute('stroke', 'var(--background-white)'); path.setAttribute('stroke-width', '2');
                svg.appendChild(path); currentAngle += angle;
            });
            container.appendChild(svg);
            const legend = document.createElement('div'); legend.style.marginTop = '20px';
            levelOrder.forEach((label, index) => {
                const count = fillLevels[label]; const item = document.createElement('div');
                item.style.cssText = 'display: flex; align-items: center; margin: 5px 0; font-size: 0.9rem;';
                item.innerHTML = `<div style="width: 16px; height: 16px; background: ${colors[index % colors.length]}; margin-right: 8px; border-radius: 3px;"></div><span>${label}: ${count} (${(count / totalWithFillLevel * 100).toFixed(1)}%)</span>`;
                legend.appendChild(item);
            });
            container.appendChild(legend);
        }

        function renderRoomUsageChart() {
            const container = document.getElementById('roomUsageChart'); if (!container) return; container.innerHTML = '';
            const roomCounts = {}; AppState.inventory.forEach(item => { if (item.room) { roomCounts[item.room] = (roomCounts[item.room] || 0) + 1; } });
            const sorted = Object.entries(roomCounts).sort((a, b) => b[1] - a[1]); const maxCount = sorted[0]?.[1] || 1;
            sorted.forEach(([room, count]) => {
                const percentage = (count / maxCount * 100); const row = document.createElement('div'); row.style.marginBottom = '15px';
                row.innerHTML = `<div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span style="font-weight: 600;">${room}</span><span>${count} Gegenstände</span></div><div class="progress-bar" style="height: 25px;"><div class="progress-fill" style="width: ${percentage}%; font-size: 0.9rem; display: flex; align-items: center; padding: 0 10px; color: white; justify-content: center;">${count > 0 ? count : ''}</div></div>`;
                container.appendChild(row);
            });
        }

        function renderDetailedStats() {
            const container = document.getElementById('detailedStats'); if (!container) return; container.innerHTML = '';
            const stats = calculateDetailedStats();
            const statsHtml = `<div class="analytics-grid"><div class="stat-card"><div class="stat-icon">📊</div><div class="stat-value">${stats.totalValue.toLocaleString('de-DE')}€</div><div class="stat-label">Geschätzter Gesamtwert</div></div><div class="stat-card"><div class="stat-icon">📈</div><div class="stat-value">${stats.avgFillLevel}%</div><div class="stat-label">Durchschn. Füllstand</div></div><div class="stat-card"><div class="stat-icon">⚡</div><div class="stat-value">${stats.avgCondition}%</div><div class="stat-label">Durchschn. Zustand</div></div><div class="stat-card"><div class="stat-icon">🔋</div><div class="stat-value">${stats.avgBattery}%</div><div class="stat-label">Durchschn. Batteriestand</div></div></div><div class="content-section mt-md"><h3>Top 5 Räume nach Gegenständen</h3><ol style="font-size: 1.1rem; line-height: 1.8; padding-left: 20px;">${stats.topRooms.map(([room, count]) => `<li>${room}: ${count} Gegenstände</li>`).join('') || '<li>Keine Daten</li>'}</ol></div><div class="content-section mt-md"><h3>Wartungsbedarf</h3><ul style="font-size: 1.1rem; line-height: 1.8; padding-left: 20px;"><li>${stats.maintenanceNeeded} Gegenstände benötigen Wartung</li><li>${stats.lowStock} Gegenstände haben niedrigen Füllstand</li><li>${stats.lowBattery} Gegenstände haben niedrigen Batteriestand</li><li>${stats.poorCondition} Gegenstände sind in schlechtem Zustand</li></ul></div>`;
            container.innerHTML = statsHtml;
        }

        function calculateDetailedStats() {
            const stats = { totalValue: 0, avgFillLevel: 0, avgCondition: 0, avgBattery: 0, topRooms: [], maintenanceNeeded: 0, lowStock: 0, lowBattery: 0, poorCondition: 0 };
            let fillCount = 0, conditionCount = 0, batteryCount = 0; let fillSum = 0, conditionSum = 0, batterySum = 0;
            AppState.inventory.forEach(item => {
                if (checkMaintenanceNeeded(item)) stats.maintenanceNeeded++;
                if (item.properties?.['Füllstand'] !== undefined) { fillSum += item.properties['Füllstand']; fillCount++; if (item.properties['Füllstand'] < AppState.settings.fillLevelThreshold) stats.lowStock++; }
                if (item.properties?.['Zustand'] !== undefined) { conditionSum += item.properties['Zustand']; conditionCount++; if (item.properties['Zustand'] < AppState.settings.conditionThreshold) stats.poorCondition++; }
                if (item.properties?.['Batterie'] !== undefined) { batterySum += item.properties['Batterie']; batteryCount++; if (item.properties['Batterie'] < AppState.settings.batteryThreshold) stats.lowBattery++; }
            });
            stats.avgFillLevel = fillCount > 0 ? Math.round(fillSum / fillCount) : 0;
            stats.avgCondition = conditionCount > 0 ? Math.round(conditionSum / conditionCount) : 0;
            stats.avgBattery = batteryCount > 0 ? Math.round(batterySum / batteryCount) : 0;
            const roomCounts = {}; AppState.inventory.forEach(item => { if(item.room) roomCounts[item.room] = (roomCounts[item.room] || 0) + 1; });
            stats.topRooms = Object.entries(roomCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            stats.totalValue = AppState.inventory.length * 50;
            return stats;
        }

        function generateAnalyticsReport() {
            const stats = calculateDetailedStats();
            const report = { generatedAt: new Date().toISOString(), summary: { totalItems: AppState.inventory.length, totalRooms: new Set(AppState.inventory.map(item => item.room).filter(Boolean)).size, estimatedValue: stats.totalValue, maintenanceNeeded: stats.maintenanceNeeded }, averages: { fillLevel: stats.avgFillLevel, condition: stats.avgCondition, battery: stats.avgBattery }, distribution: { byCategory: {}, byRoom: {}, byCondition: { excellent: 0, good: 0, fair: 0, poor: 0, critical: 0 } }, maintenanceReport: { immediate: [], upcoming: [], overdue: [] }, inventorySnapshot: AppState.inventory.map(item => ({ id: item.id, name: item.name, category: item.category, room: item.room, location: buildLocationString(item), properties: {...item.properties} })) };
            AppState.inventory.forEach(item => {
                report.distribution.byCategory[item.category] = (report.distribution.byCategory[item.category] || 0) + 1;
                if(item.room) report.distribution.byRoom[item.room] = (report.distribution.byRoom[item.room] || 0) + 1;
                const condition = item.properties?.['Zustand'] || 100;
                if (condition >= 80) report.distribution.byCondition.excellent++; else if (condition >= 60) report.distribution.byCondition.good++; else if (condition >= 40) report.distribution.byCondition.fair++; else if (condition >= 20) report.distribution.byCondition.poor++; else report.distribution.byCondition.critical++;
                const maintenanceStatus = getMaintenanceStatus(item); const itemInfo = { id: item.id, name: item.name, location: buildLocationString(item) };
                if (maintenanceStatus.overdue) report.maintenanceReport.overdue.push({...itemInfo, reason: maintenanceStatus.reason });
                else if (maintenanceStatus.upcoming) report.maintenanceReport.upcoming.push({...itemInfo, daysUntil: maintenanceStatus.daysUntil });
                else if (maintenanceStatus.immediate) report.maintenanceReport.immediate.push({...itemInfo, issues: maintenanceStatus.issues });
            });
            showNotification('Umfassender Bericht wurde erstellt (im Speicher)!', 'success');
            return report;
        }

        function exportAnalyticsJSON() { const report = generateAnalyticsReport(); const data = JSON.stringify(report, null, 2); downloadFile(data, `inventar-analyse-${new Date().toISOString().split('T')[0]}.json`, 'application/json'); }
        function downloadFile(data, filename, type) { const blob = new Blob([data], { type: type }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        function exportAnalyticsCSV() { const report = generateAnalyticsReport(); let csv = '\uFEFF'; csv += 'INVENTAR ANALYSE BERICHT\n'; csv += `Erstellt am:,${new Date(report.generatedAt).toLocaleString('de-DE')}\n\n`; csv += 'ZUSAMMENFASSUNG\n'; csv += 'Metrik,Wert\n'; csv += `Gegenstände gesamt,${report.summary.totalItems}\n`; csv += `Räume gesamt,${report.summary.totalRooms}\n`; csv += `Geschätzter Wert,"${report.summary.estimatedValue.toLocaleString('de-DE')}€"\n`; csv += `Wartung benötigt,${report.summary.maintenanceNeeded}\n\n`; csv += 'WARTUNGSBERICHT - ÜBERFÄLLIG\n'; csv += 'ID,Name,Standort,Grund\n'; report.maintenanceReport.overdue.forEach(item => { csv += `${item.id},"${item.name}","${item.location}","${item.reason.replace(/"/g, '""')}"\n`; }); csv += '\n'; downloadFile(csv, `inventar-analyse-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;'); }

        // ===== Maintenance Functions (Enhanced) =====
        function renderMaintenance() {
            const container = document.getElementById('maintenanceItems'); if (!container) return; container.innerHTML = '';
            const maintenanceItems = getMaintenanceItems();
            if (maintenanceItems.length === 0) { container.innerHTML = '<p style="text-align: center; color: var(--text-medium); font-size: 1.1rem;">Keine Wartung erforderlich</p>'; return; }
            maintenanceItems.forEach(item => {
                const card = document.createElement('div'); card.className = 'maintenance-card';
                const status = getMaintenanceStatus(item); const urgencyColor = status.overdue ? 'var(--error-color)' : status.upcoming ? 'var(--warning-color)' : status.immediate ? 'var(--info-color)' : 'transparent';
                card.style.borderLeftColor = urgencyColor;
                card.innerHTML = `<div class="maintenance-header"><h3 class="maintenance-title">${item.name}</h3><span style="color: ${urgencyColor}; font-weight: 600;">${status.overdue ? '⚠️ Überfällig' : status.upcoming ? '⏰ Anstehend' : status.immediate ? '🔧 Handeln' : ''}</span></div><p style="color: var(--text-medium); margin-bottom: 16px;">📍 ${buildLocationString(item)}</p><div class="maintenance-interval">${status.details.map(detail => `<div class="interval-item" style="border: 1px solid ${urgencyColor}; background: ${urgencyColor}20;"><strong>${detail.type}:</strong> ${detail.message}</div>`).join('')}</div><button class="btn btn-primary mt-md" onclick="showItemDetails(AppState.inventory.find(i => i.id === '${item.id}'))">Details anzeigen & Bearbeiten</button>`;
                container.appendChild(card);
            });
        }

        function getMaintenanceItems() {
            const activeFilterElement = document.querySelector('#maintenance-section .filter-chip.active[data-maintenance]');
            const activeFilter = activeFilterElement ? activeFilterElement.dataset.maintenance : 'all';
            return AppState.inventory.filter(item => {
                const status = getMaintenanceStatus(item); if (!status.needsMaintenance) return false;
                if (activeFilter === 'all') return true;
                return status.details.some(detail => {
                    const typeLower = detail.type.toLowerCase();
                    if (activeFilter === 'interval' && typeLower.includes('zeitintervall')) return true;
                    if (activeFilter === 'runtime' && typeLower.includes('laufzeit')) return true;
                    if (activeFilter === 'filllevel' && typeLower.includes('füllstand')) return true;
                    if (activeFilter === 'battery' && typeLower.includes('batterie')) return true;
                    if (activeFilter === 'condition' && typeLower.includes('zustand')) return true;
                    return false;
                });
            }).sort((a,b) => { const statusA = getMaintenanceStatus(a); const statusB = getMaintenanceStatus(b); if (statusA.overdue && !statusB.overdue) return -1; if (!statusA.overdue && statusB.overdue) return 1; if (statusA.upcoming && !statusB.upcoming) return -1; if (!statusA.upcoming && statusB.upcoming) return 1; return 0; });
        }

        function getMaintenanceStatus(item) {
            const status = { needsMaintenance: false, overdue: false, upcoming: false, immediate: false, details: [], issues: [], reason: '', daysUntil: null }; const now = new Date();
            if (item.maintenanceInterval && item.lastMaintenance) {
                const lastMaintenanceDate = new Date(item.lastMaintenance); const daysSince = Math.floor((now - lastMaintenanceDate) / (1000 * 60 * 60 * 24)); const daysToNext = item.maintenanceInterval - daysSince;
                if (daysToNext <= 0) { status.overdue = true; status.reason = `Seit ${Math.abs(daysToNext)} Tag(en) überfällig`; status.details.push({ type: 'Zeitintervall', message: status.reason }); }
                else if (daysToNext <= AppState.settings.maintenanceDaysBefore) { status.upcoming = true; status.daysUntil = daysToNext; status.details.push({ type: 'Zeitintervall', message: `In ${daysToNext} Tag(en) fällig` }); }
            }
            if (item.runtime && item.totalRuntime >= item.runtime) { status.immediate = true; status.details.push({ type: 'Laufzeit', message: `Grenze erreicht (${item.totalRuntime}/${item.runtime}h)` }); }
            if (item.properties) {
                if (item.properties['Füllstand'] !== undefined && item.properties['Füllstand'] < AppState.settings.fillLevelThreshold) { status.immediate = true; status.issues.push('Niedriger Füllstand'); status.details.push({ type: 'Füllstand', message: `${item.properties['Füllstand']}% (Limit: ${AppState.settings.fillLevelThreshold}%)` }); }
                if (item.properties['Batterie'] !== undefined && item.properties['Batterie'] < AppState.settings.batteryThreshold) { status.immediate = true; status.issues.push('Niedrige Batterie'); status.details.push({ type: 'Batteriestand', message: `${item.properties['Batterie']}% (Limit: ${AppState.settings.batteryThreshold}%)` }); }
                if (item.properties['Zustand'] !== undefined && item.properties['Zustand'] < AppState.settings.conditionThreshold) { status.immediate = true; status.issues.push('Schlechter Zustand'); status.details.push({ type: 'Zustand', message: `${item.properties['Zustand']}% (Limit: ${AppState.settings.conditionThreshold}%)` }); }
            }
            status.needsMaintenance = status.overdue || status.upcoming || status.immediate; return status;
        }
        function checkMaintenanceNeeded(item) { return getMaintenanceStatus(item).needsMaintenance; }

        function openMaintenanceSettings() {
            const modal = document.getElementById('maintenanceModal'); const content = document.getElementById('maintenanceModalContent'); if (!modal || !content) return;
            content.innerHTML = `<div class="form-group"><label class="form-label">Füllstand Warnung unter (%)</label><input type="number" id="modalFillThreshold" class="form-input" min="0" max="100" value="${AppState.settings.fillLevelThreshold}"></div><div class="form-group"><label class="form-label">Batteriestand Warnung unter (%)</label><input type="number" id="modalBatteryThreshold" class="form-input" min="0" max="100" value="${AppState.settings.batteryThreshold}"></div><div class="form-group"><label class="form-label">Zustand Warnung unter (%)</label><input type="number" id="modalConditionThreshold" class="form-input" min="0" max="100" value="${AppState.settings.conditionThreshold}"></div><div class="form-group"><label class="form-label">Wartung X Tage vorher warnen</label><input type="number" id="modalMaintenanceDays" class="form-input" min="1" value="${AppState.settings.maintenanceDaysBefore}"></div><button class="btn btn-primary" id="saveMaintenanceModalSettingsBtn">Einstellungen speichern</button>`;
            document.getElementById('saveMaintenanceModalSettingsBtn').onclick = saveMaintenanceSettingsFromModal; modal.classList.add('active');
        }
        function saveMaintenanceSettingsFromModal() {
            AppState.settings.fillLevelThreshold = parseInt(document.getElementById('modalFillThreshold').value) || 20; AppState.settings.batteryThreshold = parseInt(document.getElementById('modalBatteryThreshold').value) || 25; AppState.settings.conditionThreshold = parseInt(document.getElementById('modalConditionThreshold').value) || 30; AppState.settings.maintenanceDaysBefore = parseInt(document.getElementById('modalMaintenanceDays').value) || 7;
            document.getElementById('fillLevelThreshold').value = AppState.settings.fillLevelThreshold; document.getElementById('batteryThreshold').value = AppState.settings.batteryThreshold; document.getElementById('conditionThreshold').value = AppState.settings.conditionThreshold; document.getElementById('maintenanceDaysBefore').value = AppState.settings.maintenanceDaysBefore;
            saveDataToStorage(); showNotification('Wartungseinstellungen gespeichert!', 'success'); closeModal('maintenanceModal'); if (AppState.currentSection === 'maintenance') renderMaintenance(); if (AppState.currentSection === 'dashboard') updateDashboard();
        }
        function updateMaintenanceThresholds() {
            AppState.settings.fillLevelThreshold = parseInt(document.getElementById('fillLevelThreshold').value) || 20; AppState.settings.batteryThreshold = parseInt(document.getElementById('batteryThreshold').value) || 25; AppState.settings.conditionThreshold = parseInt(document.getElementById('conditionThreshold').value) || 30; AppState.settings.maintenanceDaysBefore = parseInt(document.getElementById('maintenanceDaysBefore').value) || 7;
            saveDataToStorage(); showNotification('Wartungsgrenzwerte aktualisiert.', 'info'); if (AppState.currentSection === 'maintenance') renderMaintenance(); if (AppState.currentSection === 'dashboard') updateDashboard();
        }

        // ===== Settings Functions =====
        function renderSettings() {
            document.getElementById('showIDsToggle').checked = AppState.settings.showIDs;
            document.getElementById('speechRate').value = AppState.settings.speechRate || 1;
            document.getElementById('speechRateValue').textContent = (AppState.settings.speechRate || 1).toFixed(1);
            document.getElementById('ttsProvider').value = AppState.settings.ttsProvider || 'browser';
            document.getElementById('sttProvider').value = AppState.settings.sttProvider || 'browser';
            document.getElementById('fillLevelThreshold').value = AppState.settings.fillLevelThreshold || 20;
            document.getElementById('batteryThreshold').value = AppState.settings.batteryThreshold || 25;
            document.getElementById('conditionThreshold').value = AppState.settings.conditionThreshold || 30;
            document.getElementById('maintenanceDaysBefore').value = AppState.settings.maintenanceDaysBefore || 7;
            document.getElementById('categoriesConfig').value = AppState.categories.join('\n');
            document.getElementById('propertiesConfig').value = AppState.properties.join('\n');
        }
        function toggleShowIDs(e) { AppState.settings.showIDs = e.target.checked; saveDataToStorage(); renderCurrentSection(); showNotification(`IDs werden ${AppState.settings.showIDs ? 'angezeigt' : 'versteckt'}`, 'info'); }
        function updateSpeechRate(e) { AppState.settings.speechRate = parseFloat(e.target.value); document.getElementById('speechRateValue').textContent = AppState.settings.speechRate.toFixed(1); saveDataToStorage(); }
        function updateTTSProvider(e) { AppState.settings.ttsProvider = e.target.value; saveDataToStorage(); showNotification(`TTS-Provider auf ${e.target.value} geändert`, 'info'); }
        function updateSTTProvider(e) { AppState.settings.sttProvider = e.target.value; saveDataToStorage(); showNotification(`STT-Provider auf ${e.target.value} geändert`, 'info'); }
        function saveConfiguration() {
            const categories = document.getElementById('categoriesConfig').value.split('\n').map(cat => cat.trim()).filter(cat => cat); AppState.categories = categories.length > 0 ? categories : AppState.categories;
            const properties = document.getElementById('propertiesConfig').value.split('\n').map(prop => prop.trim()).filter(prop => prop); AppState.properties = properties.length > 0 ? properties : AppState.properties;
            saveDataToStorage(); showNotification('Konfiguration gespeichert!', 'success');
            if (AppState.currentSection === 'add') { initializeAddForm(); }
        }

        // ===== Search & Filter Functions =====
        function initializeSearch() { renderCategoryFilters('#search-section #categoryFilters'); handleSearch(); }
        function renderCategoryFilters(containerSelector) {
            const container = document.querySelector(containerSelector); if(!container) return; container.innerHTML = '';
            const uniqueCategories = [...new Set(AppState.inventory.map(item => item.category).filter(Boolean))];
            uniqueCategories.forEach(category => {
                const chip = document.createElement('div'); chip.className = 'filter-chip'; chip.dataset.filterCategory = category; chip.textContent = category;
                chip.onclick = () => { chip.classList.toggle('active'); handleSearch(); };
                if (AppState.filters.category === category) chip.classList.add('active'); container.appendChild(chip);
            });
        }
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeConditionFilters = Array.from(document.querySelectorAll('#search-section .filter-chip[data-filter].active')).map(chip => chip.dataset.filter);
            const activeCategoryFilters = Array.from(document.querySelectorAll('#search-section .filter-chip[data-filter-category].active')).map(chip => chip.dataset.filterCategory);
            AppState.filters.search = searchTerm;
            let results = AppState.inventory;
            if (searchTerm) { results = results.filter(item => Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm)) || (item.properties && Object.entries(item.properties).some(([propKey, propVal]) => propKey.toLowerCase().includes(searchTerm) || String(propVal).toLowerCase().includes(searchTerm))) ); }
            if (activeCategoryFilters.length > 0) { results = results.filter(item => activeCategoryFilters.includes(item.category)); }
            if (activeConditionFilters.length > 0 && !activeConditionFilters.includes('all')) {
                results = results.filter(item => {
                    return activeConditionFilters.some(filterType => {
                        switch (filterType) {
                            case 'low-stock': return (item.properties?.['Füllstand'] || 100) < AppState.settings.fillLevelThreshold;
                            case 'full': return (item.properties?.['Füllstand'] || 0) >= 80;
                            case 'poor-condition': return (item.properties?.['Zustand'] || 100) < AppState.settings.conditionThreshold;
                            case 'low-battery': return (item.properties?.['Batterie'] || 100) < AppState.settings.batteryThreshold;
                            case 'maintenance': return checkMaintenanceNeeded(item);
                            default: return true;
                        }
                    });
                });
            }
            renderSearchResults(results);
        }
        function renderSearchResults(results) {
            const container = document.getElementById('searchResults'); container.innerHTML = '';
            if (results.length === 0) { container.innerHTML = '<p style="text-align: center; color: var(--text-medium); font-size: 1.1rem;">Keine Ergebnisse für Ihre Filterkriterien gefunden.</p>'; return; }
            results.forEach(item => container.appendChild(createInventoryCard(item)));
        }
        function setupFilterChips() {
            document.querySelectorAll('#search-section .filter-chip[data-filter]').forEach(chip => {
                chip.addEventListener('click', () => {
                    const isAllChip = chip.dataset.filter === 'all';
                    if (isAllChip) { document.querySelectorAll('#search-section .filter-chip[data-filter]').forEach(c => c.classList.remove('active')); chip.classList.add('active'); }
                    else { document.querySelector('#search-section .filter-chip[data-filter="all"]')?.classList.remove('active'); chip.classList.toggle('active'); if (!document.querySelector('#search-section .filter-chip[data-filter].active:not([data-filter="all"])')) { document.querySelector('#search-section .filter-chip[data-filter="all"]')?.classList.add('active'); } }
                    handleSearch();
                });
            });
            document.querySelectorAll('#maintenance-section .filter-chip[data-maintenance]').forEach(chip => {
                chip.addEventListener('click', () => { document.querySelectorAll('#maintenance-section .filter-chip[data-maintenance]').forEach(c => c.classList.remove('active')); chip.classList.add('active'); renderMaintenance(); });
            });
        }

        // ===== Inventory Tree View =====
        function renderInventoryTree() {
            const container = document.getElementById('inventoryTree'); if(!container) return; container.innerHTML = '';
            if (AppState.inventory.length === 0) { container.innerHTML = '<p style="text-align:center; color:var(--text-medium);">Das Inventar ist leer.</p>'; return; }
            const roomGroups = {};
            AppState.inventory.forEach(item => {
                const roomName = item.room || 'Unbekannter Raum'; if (!roomGroups[roomName]) roomGroups[roomName] = { items: [], furniture: {} };
                const furnitureKey = item.furniture || 'Ohne Möbelstück';
                if (item.furniture) {
                    if (!roomGroups[roomName].furniture[furnitureKey]) { roomGroups[roomName].furniture[furnitureKey] = { items: [], containers: {} }; }
                    const containerKey = item.container || 'Ohne Container';
                    if (item.container) {
                         if (!roomGroups[roomName].furniture[furnitureKey].containers[containerKey]) { roomGroups[roomName].furniture[furnitureKey].containers[containerKey] = []; }
                        roomGroups[roomName].furniture[furnitureKey].containers[containerKey].push(item);
                    } else { roomGroups[roomName].furniture[furnitureKey].items.push(item); }
                } else { roomGroups[roomName].items.push(item); }
            });
            Object.entries(roomGroups).sort((a,b) => a[0].localeCompare(b[0])).forEach(([roomName, roomData]) => {
                const roomElement = createTreeNode(roomName, 'room', '🏠'); const roomChildrenContainer = roomElement.querySelector('.tree-children');
                roomData.items.forEach(item => roomChildrenContainer.appendChild(createTreeItem(item)));
                Object.entries(roomData.furniture).sort((a,b) => a[0].localeCompare(b[0])).forEach(([furnitureName, furnitureData]) => {
                    if (furnitureName !== 'Ohne Möbelstück') {
                        const furnitureElement = createTreeNode(furnitureName, 'furniture', '🪑'); const furnitureChildrenContainer = furnitureElement.querySelector('.tree-children');
                        furnitureData.items.forEach(item => furnitureChildrenContainer.appendChild(createTreeItem(item)));
                        Object.entries(furnitureData.containers).sort((a,b) => a[0].localeCompare(b[0])).forEach(([containerName, items]) => {
                             if (containerName !== 'Ohne Container') {
                                const containerElement = createTreeNode(containerName, 'container', '📁'); const containerChildrenContainer = containerElement.querySelector('.tree-children');
                                items.forEach(item => containerChildrenContainer.appendChild(createTreeItem(item))); furnitureChildrenContainer.appendChild(containerElement);
                             } else { items.forEach(item => furnitureChildrenContainer.appendChild(createTreeItem(item))); }
                        });
                        roomChildrenContainer.appendChild(furnitureElement);
                    }
                });
                container.appendChild(roomElement);
            });
        }
        function createTreeNode(name, type, icon) {
            const node = document.createElement('div'); node.className = `tree-node tree-node-${type}`;
            node.innerHTML = `<div class="tree-header" onclick="toggleTreeNode(this)" tabindex="0" role="button" aria-expanded="false" aria-controls="children-${name.replace(/\s+/g, '-')}" style="padding: 12px; background: var(--background-light); border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;"><span class="tree-toggle" style="transition: transform 0.2s; display:inline-block; width: 1em;">▶</span><span>${icon}</span><span style="font-weight: 600; font-size: 1.1rem;">${name}</span></div><div class="tree-children" id="children-${name.replace(/\s+/g, '-')}" style="margin-left: 24px; display: none;"></div>`;
            node.querySelector('.tree-header').addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleTreeNode(e.currentTarget); } });
            return node;
        }
        function createTreeItem(item) {
            const element = document.createElement('div'); element.className = 'tree-item'; element.tabIndex = 0; element.setAttribute('role', 'button');
            element.style.cssText = `padding: 10px 12px; background: var(--background-white); border: 2px solid var(--border-color); border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;`;
            const categoryIcon = item.category ? item.category.split(' ')[0] : '📦'; const maintenanceIcon = checkMaintenanceNeeded(item) ? ' <span title="Wartung nötig" style="color: var(--warning-color);">🔧</span>' : '';
            element.innerHTML = `<span style="font-size: 1.2rem;">${categoryIcon}</span><span style="font-size: 1.1rem;">${item.name}${maintenanceIcon}</span>${item.position && item.position !== 'darin' ? `<span style="font-style: italic; color: var(--text-medium);">(${item.position})</span>` : ''}${AppState.settings.showIDs ? `<small style="color: var(--text-medium); margin-left: auto; font-family: monospace;">ID: ${item.id}</small>` : ''}`;
            element.onclick = () => showItemDetails(item); element.addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showItemDetails(item); } });
            element.onmouseover = () => { element.style.background = 'var(--background-light)'; element.style.borderColor = 'var(--primary-green)'; };
            element.onmouseout = () => { element.style.background = 'var(--background-white)'; element.style.borderColor = 'var(--border-color)'; };
            element.onfocus = () => element.style.outline = '2px solid var(--primary-dark)'; element.onblur = () => element.style.outline = 'none';
            return element;
        }
        function toggleTreeNode(header) { const toggle = header.querySelector('.tree-toggle'); const children = header.nextElementSibling; const isExpanded = children.style.display !== 'none'; children.style.display = isExpanded ? 'none' : 'block'; toggle.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(90deg)'; header.setAttribute('aria-expanded', !isExpanded); }
        let allNodesExpanded = false;
        function toggleTreeView() {
            const allHeaders = document.querySelectorAll('.tree-header'); allNodesExpanded = !allNodesExpanded;
            allHeaders.forEach(header => { const children = header.nextElementSibling; const toggle = header.querySelector('.tree-toggle'); if (children && toggle) { children.style.display = allNodesExpanded ? 'block' : 'none'; toggle.style.transform = allNodesExpanded ? 'rotate(90deg)' : 'rotate(0deg)'; header.setAttribute('aria-expanded', allNodesExpanded); } });
            document.getElementById('toggleTreeView').querySelector('span:last-child').textContent = allNodesExpanded ? 'Alle zuklappen' : 'Alle aufklappen';
        }

        // ===== Form Initialization =====
        function initializeAddForm() {
            const roomSelect = document.getElementById('itemRoom'); if (!roomSelect) return; const currentRoomValue = roomSelect.value;
            roomSelect.innerHTML = '<option value="">Raum auswählen...</option>';
            const rooms = [...new Set(AppState.inventory.map(item => item.room).filter(Boolean))].sort();
            rooms.forEach(room => { const option = document.createElement('option'); option.value = room; option.textContent = room; roomSelect.appendChild(option); });
            const newRoomOption = document.createElement('option'); newRoomOption.value = '__new__'; newRoomOption.textContent = '+ Neuer Raum'; roomSelect.appendChild(newRoomOption);
            if (currentRoomValue && rooms.includes(currentRoomValue)) { roomSelect.value = currentRoomValue; }
            roomSelect.onchange = (e) => {
                if (e.target.value === '__new__') {
                    const newRoom = prompt('Name des neuen Raums:');
                    if (newRoom && newRoom.trim()) {
                        const trimmedNewRoom = newRoom.trim();
                        if (!rooms.includes(trimmedNewRoom)) {
                            const option = document.createElement('option'); option.value = trimmedNewRoom; option.textContent = trimmedNewRoom;
                            roomSelect.insertBefore(option, roomSelect.options[roomSelect.options.length -1]); rooms.push(trimmedNewRoom); rooms.sort();
                        }
                        roomSelect.value = trimmedNewRoom;
                    } else { roomSelect.value = ''; }
                }
            };
            renderCategorySelection('#add-section #categorySelection'); renderPropertySliders('#add-section #propertySliders');
        }
        function renderCategorySelection(containerSelector) {
            const container = document.querySelector(containerSelector); if(!container) return; container.innerHTML = '';
            AppState.categories.forEach(category => {
                const chip = document.createElement('div'); chip.className = 'filter-chip'; chip.dataset.category = category; chip.textContent = category; chip.tabIndex = 0; chip.setAttribute('role', 'radio'); chip.setAttribute('aria-checked', 'false');
                chip.onclick = () => selectCategoryChip(chip, containerSelector);
                chip.onkeypress = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectCategoryChip(chip, containerSelector); } };
                container.appendChild(chip);
            });
        }
        function selectCategoryChip(chip, containerSelector) { document.querySelectorAll(`${containerSelector} .filter-chip`).forEach(c => { c.classList.remove('active'); c.setAttribute('aria-checked', 'false'); }); chip.classList.add('active'); chip.setAttribute('aria-checked', 'true'); }
        function renderPropertySliders(containerSelector) {
            const container = document.querySelector(containerSelector); if(!container) return; container.innerHTML = '';
            AppState.properties.forEach(property => {
                const uniqueIdSuffix = property.replace(/\s+/g, '-').toLowerCase();
                const group = document.createElement('div'); group.className = 'form-group';
                group.innerHTML = `<label class="form-label" for="slider-${uniqueIdSuffix}">${property}: <span id="value-${uniqueIdSuffix}">50</span>%</label><input type="range" id="slider-${uniqueIdSuffix}" class="form-input property-slider" data-property="${property}" min="0" max="100" value="50" oninput="updateSliderValue('${uniqueIdSuffix}', this.value, '${property}')"><div class="progress-bar"><div class="progress-fill" id="fill-${uniqueIdSuffix}" style="width: 50%;"></div></div>`;
                container.appendChild(group);
            });
        }
        function updateSliderValue(idSuffix, value, propertyName) { document.getElementById(`value-${idSuffix}`).textContent = value; document.getElementById(`fill-${idSuffix}`).style.width = value + '%';}
        function addCustomProperty() {
            const propertyName = prompt('Name der neuen Eigenschaft (z.B. Gewicht, Größe):');
            if (propertyName && propertyName.trim()) {
                const trimmedName = propertyName.trim();
                if (!AppState.properties.includes(trimmedName)) { AppState.properties.push(trimmedName); renderPropertySliders('#add-section #propertySliders'); saveDataToStorage(); showNotification(`Eigenschaft "${trimmedName}" hinzugefügt!`, 'success'); }
                else { showNotification(`Eigenschaft "${trimmedName}" existiert bereits.`, 'warning'); }
            }
        }

        // ===== Import/Export Functions =====
        function exportJSON() { const data = JSON.stringify(AppState, null, 2); downloadFile(data, `inventar-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json'); showNotification('JSON-Export erfolgreich!', 'success'); }
        function exportCSV() {
            const headers = ['ID', 'Name', 'Raum', 'Möbel', 'Container', 'Position', 'Kategorie', 'Wartungsintervall (Tage)', 'Laufzeit (Stunden)', 'Gesamtlaufzeit (Stunden)', 'Notizen', 'Hinzugefügt am', 'Zuletzt geändert'];
            AppState.properties.forEach(prop => headers.push(prop));
            const rows = [headers.join(',')];
            AppState.inventory.forEach(item => {
                const row = [ item.id, `"${item.name.replace(/"/g, '""')}"`, `"${(item.room || '').replace(/"/g, '""')}"`, `"${(item.furniture || '').replace(/"/g, '""')}"`, `"${(item.container || '').replace(/"/g, '""')}"`, item.position || 'darin', `"${(item.category || 'Sonstiges').replace(/"/g, '""')}"`, item.maintenanceInterval || '', item.runtime || '', item.totalRuntime || '', `"${(item.notes || '').replace(/"/g, '""')}"`, new Date(item.dateAdded).toLocaleString('de-DE'), new Date(item.lastModified).toLocaleString('de-DE') ];
                AppState.properties.forEach(prop => { row.push(item.properties?.[prop] || ''); });
                rows.push(row.join(','));
            });
            downloadFile(rows.join('\n'), `inventar-export-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
            showNotification('CSV-Export (Excel-kompatibel) erfolgreich!', 'success');
        }
        function exportInventory() { const choice = confirm('Sollen die Daten im JSON-Format (OK) oder CSV-Format (Abbrechen) exportiert werden?'); if (choice) { exportJSON(); } else { exportCSV(); } }
        function handleImport(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader(); const filename = file.name.toLowerCase();
            reader.onload = (event) => {
                try {
                    if (filename.endsWith('.json')) {
                        const data = JSON.parse(event.target.result);
                        if (confirm('JSON-Import: Dies wird alle aktuellen Daten ersetzen. Fortfahren?')) {
                            for (const key in data) { if (Object.prototype.hasOwnProperty.call(data, key) && Object.prototype.hasOwnProperty.call(AppState, key)) { AppState[key] = data[key]; } }
                            loadDataFromStorage(); saveDataToStorage(); initializeApp();
                            showNotification('JSON-Import erfolgreich! App wird neu initialisiert.', 'success');
                        }
                    } else if (filename.endsWith('.csv')) {
                        const csvData = event.target.result;
                        const rows = csvData.split('\n').map(row => {
                            const cells = []; let cell = ''; let inQuotes = false;
                            for (let i = 0; i < row.length; i++) { const char = row[i]; const nextChar = row[i+1]; if (char === '"' && nextChar === '"' && inQuotes) { cell += '"'; i++; } else if (char === '"') { inQuotes = !inQuotes; } else if (char === ',' && !inQuotes) { cells.push(cell.trim()); cell = ''; } else { cell += char; } }
                            cells.push(cell.trim()); return cells;
                        });
                        if (rows.length < 2) throw new Error('CSV-Datei ist leer oder hat keine Datenzeilen.');
                        const headers = rows[0].map(h => h.toLowerCase().trim()); const items = [];
                        const expectedHeaders = ['id', 'name', 'raum', 'möbel', 'container', 'position', 'kategorie', 'wartungsintervall (tage)', 'laufzeit (stunden)', 'gesamtlaufzeit (stunden)', 'notizen', 'hinzugefügt am', 'zuletzt geändert'];
                        const propertyHeaders = headers.slice(expectedHeaders.length);
                        for (let i = 1; i < rows.length; i++) {
                            const rowValues = rows[i]; if (rowValues.length < headers.length || rowValues.every(val => !val)) continue;
                            const item = {};
                            headers.forEach((header, index) => {
                                const val = rowValues[index];
                                if (header === 'id') item.id = val || generateItemId(); else if (header === 'name') item.name = val; else if (header === 'raum') item.room = val; else if (header === 'möbel') item.furniture = val || null; else if (header === 'container') item.container = val || null; else if (header === 'position') item.position = val || 'darin'; else if (header === 'kategorie') item.category = val || 'Sonstiges'; else if (header === 'wartungsintervall (tage)') item.maintenanceInterval = parseInt(val) || null; else if (header === 'laufzeit (stunden)') item.runtime = parseFloat(val) || null; else if (header === 'gesamtlaufzeit (stunden)') item.totalRuntime = parseFloat(val) || 0; else if (header === 'notizen') item.notes = val || ''; else if (header === 'hinzugefügt am') item.dateAdded = val ? new Date(val).toISOString() : new Date().toISOString(); else if (header === 'zuletzt geändert') item.lastModified = val ? new Date(val).toISOString() : new Date().toISOString();
                                else if (AppState.properties.includes(header) || propertyHeaders.includes(header)) { if (!item.properties) item.properties = {}; item.properties[header] = parseInt(val) || 0; }
                            });
                            if (!item.id) item.id = generateItemId(); if (!item.dateAdded) item.dateAdded = new Date().toISOString(); if (!item.lastModified) item.lastModified = new Date().toISOString(); if (!item.properties) item.properties = {};
                            items.push(item);
                        }
                        if (confirm(`${items.length} Gegenstände aus CSV gefunden. Importieren und aktuelle Daten überschreiben?`)) { AppState.inventory = items; loadDataFromStorage(); saveDataToStorage(); initializeApp(); showNotification(`${items.length} Gegenstände importiert! App wird neu initialisiert.`, 'success'); }
                    } else { showNotification('Ungültiger Dateityp. Bitte JSON oder CSV Datei auswählen.', 'error'); }
                } catch (error) { console.error("Import Fehler:", error); showNotification('Fehler beim Import: ' + error.message, 'error'); }
                finally { e.target.value = ''; }
            };
            if (file.name.endsWith('.json') || file.name.endsWith('.csv')) { reader.readAsText(file, 'UTF-8'); }
            else { showNotification('Ungültiger Dateityp. Nur .json oder .csv Dateien.', 'error'); e.target.value = ''; }
        }
        function clearAllData() {
            if (confirm('WARNUNG: Dies wird ALLE Daten unwiderruflich löschen! Sind Sie sicher?')) {
                if (confirm('Wirklich ALLE Daten löschen? Diese Aktion kann nicht rückgängig gemacht werden!')) {
                    localStorage.removeItem('inventarProData');
                    AppState.inventory = []; AppState.rooms = []; AppState.categories = ['📱 Elektronik', '🔧 Werkzeug', '👕 Kleidung', '📚 Bücher', '🍴 Küche', '🎮 Gaming', '🏠 Haushalt', '💊 Medizin']; AppState.properties = ['Füllstand', 'Zustand', 'Batterie', 'Sauberkeit', 'Wichtigkeit']; AppState.roomPlans = {}; AppState.nextId = 1001;
                    AppState.settings = { theme: 'light', autoSave: true, showIDs: false, speechRate: 1, speechVolume: 1, ttsProvider: 'browser', sttProvider: 'browser', fillLevelThreshold: 20, batteryThreshold: 25, conditionThreshold: 30, maintenanceDaysBefore: 7 };
                    AppState.currentSection = 'dashboard'; AppState.filters = { search: '', category: null, conditions: [] };
                    saveDataToStorage(); initializeApp(); showNotification('Alle Daten wurden gelöscht.', 'success');
                }
            }
        }

        // ===== Modal Functions =====
        function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('active'); }
        document.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) { closeModal(e.target.id); } });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { document.querySelectorAll('.modal.active').forEach(modal => closeModal(modal.id)); } });

        // ===== Keyboard Shortcuts =====
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveDataToStorage(); showNotification('Daten manuell gespeichert!', 'success'); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); navigateToSection('search'); const searchInput = document.getElementById('searchInput'); if(searchInput) searchInput.focus(); }
            if (((e.ctrlKey || e.metaKey) && e.key === 'n') || (e.altKey && e.key.toLowerCase() === 'a')) { e.preventDefault(); navigateToSection('add'); }
        });

        // ===== Notification System =====
        let notificationTimeout;
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer'); if (!container) return;
            if (notificationTimeout) clearTimeout(notificationTimeout); const existingNotification = container.querySelector('.notification'); if (existingNotification) existingNotification.remove();
            const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.setAttribute('role', 'alert');
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            notification.innerHTML = `<span>${icon}</span><span style="flex-grow: 1;">${message}</span><button class="modal-close" style="font-size: 1rem; padding: 0.2rem 0.5rem; margin-left: 1rem;" onclick="this.parentElement.remove()">✕</button>`;
            notification.style.animation = ''; requestAnimationFrame(() => { notification.style.animation = 'slideInRight 0.5s ease forwards'; });
            container.appendChild(notification);
            notificationTimeout = setTimeout(() => { notification.style.animation = 'slideOutRight 0.5s ease forwards'; setTimeout(() => notification.remove(), 500); }, duration);
        }

        // ===== Utility Functions =====
        function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }

        // Style for toggle switch
        const styleElement = document.createElement('style');
        styleElement.textContent = `.switch { position: relative; display: inline-block; width: 50px; height: 26px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 26px; } .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--primary-green); } input:focus + .slider { box-shadow: 0 0 0 2px var(--primary-dark); } input:checked + .slider:before { transform: translateX(24px); }`;
        document.head.appendChild(styleElement);
        console.log('Inventartor Pro 2.0 geladen und bereit!');
    </script>
</body>
</html>
